import{G as r,M as g,$ as e,T as G,c as i,b as m,A as O,h as M,a as w}from"./DarkTheme-59411532.js";import{a as d,F as t,k as re,l as I,n as ce,m as E,s as c,o as ue,p as _e,i as N}from"./main-7461ba9d.js";import{s as p}from"./sensor_types-c2bb3cb2.js";const f={yaw_fix:0};f.initialize=function(u){const o=this;r.active_tab!="setup"&&(r.active_tab="setup");function S(){g.send_message(d.MSP_STATUS_EX,!1,!1,x)}function x(){g.send_message(d.MSP2_MCU_INFO,!1,!1,B)}function B(){g.send_message(d.MSP_MIXER_CONFIG,!1,!1,y)}function y(){e("#content").load("./tabs/setup.html",D)}g.send_message(d.MSP_ACC_TRIM,!1,!1,S);function D(){i.localizePage(),o.initModel(),e("span.roll").text(i.getMessage("initialSetupAttitude",[0])),e("span.pitch").text(i.getMessage("initialSetupAttitude",[0])),e("span.heading").text(i.getMessage("initialSetupAttitude",[0])),I(t.CONFIG.activeSensors,"acc")||(e("a.calibrateAccel").addClass("disabled"),e("default_btn").addClass("disabled")),I(t.CONFIG.activeSensors,"mag")||(e("a.calibrateMag").addClass("disabled"),e("default_btn").addClass("disabled")),o.initializeInstruments(),e("#arming-disable-flag").attr("title",i.getMessage("initialSetupArmingDisableFlagsTooltip")),ce()?e(".initialSetupRebootBootloader").show():e(".initialSetupRebootBootloader").hide(),e("a.rebootBootloader").click(function(){const a=[];a.push(t.boardHasFlashBootloader()?E.REBOOT_TYPES.BOOTLOADER_FLASH:E.REBOOT_TYPES.BOOTLOADER),g.send_message(d.MSP_SET_REBOOT,a,!1)}),e("a.calibrateAccel").click(function(){const a=e(this);a.hasClass("calibrating")||(a.addClass("calibrating"),r.interval_pause("setup_data_pull"),g.send_message(d.MSP_ACC_CALIBRATION,!1,!1,function(){m(i.getMessage("initialSetupAccelCalibStarted")),e("#accel_calib_running").show(),e("#accel_calib_rest").hide()}),r.timeout_add("button_reset",function(){r.interval_resume("setup_data_pull"),m(i.getMessage("initialSetupAccelCalibEnded")),a.removeClass("calibrating"),e("#accel_calib_running").hide(),e("#accel_calib_rest").show()},2e3))}),e("a.calibrateMag").click(function(){const a=e(this);if(!a.hasClass("calibrating")&&!a.hasClass("disabled")){let s=function(){m(i.getMessage("initialSetupMagCalibEnded")),a.removeClass("calibrating"),e("#mag_calib_running").hide(),e("#mag_calib_rest").show()};if(a.addClass("calibrating"),g.send_message(d.MSP_MAG_CALIBRATION,!1,!1,function(){m(i.getMessage("initialSetupMagCalibStarted")),e("#mag_calib_running").show(),e("#mag_calib_rest").hide()}),c.gte(t.CONFIG.apiVersion,O)){let n=0;const l=45,de=setInterval(function(){(n>=l||!(t.CONFIG.armingDisableFlags&4096))&&(clearInterval(de),s()),n++},1e3)}else r.timeout_add("button_reset",s,3e4)}});const b=e(".dialogConfirmReset")[0];e("a.resetSettings").click(function(){b.showModal()}),e(".dialogConfirmReset-cancelbtn").click(function(){b.close()}),e(".dialogConfirmReset-confirmbtn").click(function(){b.close(),g.send_message(d.MSP_RESET_CONF,!1,!1,function(){m(i.getMessage("initialSetupSettingsRestored")),r.tab_switch_cleanup(function(){G.setup.initialize()})})}),e("div#interactive_block > a.reset").text(i.getMessage("initialSetupButtonResetZaxisValue",[o.yaw_fix])),e("div#interactive_block > a.reset").click(function(){o.yaw_fix=t.SENSOR_DATA.kinematics[2]*-1,e(this).text(i.getMessage("initialSetupButtonResetZaxisValue",[o.yaw_fix])),console.log(`YAW reset to 0 deg, fix: ${o.yaw_fix} deg`)});const v=e(".bat-voltage"),L=e(".bat-mah-drawn"),$=e(".bat-mah-drawing"),P=e(".rssi"),T=e(".cpu-temp"),A=e(".arming-disable-flags"),F=e(".GPS_info span.colorToggle"),k=e(".gpsSats"),V=e("dd.roll"),H=e("dd.pitch"),z=e("dd.heading"),U=e(".sonarAltitude"),R=e(".mcu"),Y=e(".sensor_gyro_hw"),K=e(".sensor_acc_hw"),W=e(".sensor_mag_hw"),X=e(".sensor_baro_hw"),Z=e(".sensor_sonar_hw"),j=e(".sensor_opticalflow_hw"),q=e(".api-version"),Q=e(".build-date"),J=e(".build-type"),h=e(".build-info"),C=e(".build-options"),ee=function(){let a=["NO_GYRO","FAILSAFE","RX_FAILSAFE","NOT_DISARMED","BOXFAILSAFE","RUNAWAY_TAKEOFF","CRASH_DETECTED","THROTTLE","ANGLE","BOOT_GRACE_TIME","NOPREARM","LOAD","CALIBRATING","CLI","CMS_MENU","BST","MSP","PARALYZE","GPS","RESC","RPMFILTER","REBOOT_REQUIRED","DSHOT_BITBANG","ACC_CALIBRATION","MOTOR_PROTOCOL"];c.gte(t.CONFIG.apiVersion,O)&&ue(a,"RPMFILTER","DSHOT_TELEM"),c.gte(t.CONFIG.apiVersion,M)&&_e(a,"MOTOR_PROTOCOL",["CRASHFLIP","ALTHOLD","POSHOLD"]),A.append('<span id="initialSetupArmingAllowed" i18n="initialSetupArmingAllowed" style="display: none;"></span>');for(let s=0;s<t.CONFIG.armingDisableCount;s++)if(s<a.length-1){const n=`initialSetupArmingDisableFlagsTooltip${a[s]}`;A.append(`<span id="initialSetupArmingDisableFlags${s}" class="cf_tip disarm-flag" title="${i.getMessage(n)}" style="display: none;">${a[s]}</span>`)}else s==t.CONFIG.armingDisableCount-1?A.append(`<span id="initialSetupArmingDisableFlags${s}" class="cf_tip disarm-flag" title="${i.getMessage("initialSetupArmingDisableFlagsTooltipARM_SWITCH")}" style="display: none;">ARM_SWITCH</span>`):A.append(`<span id="initialSetupArmingDisableFlags${s}" class="disarm-flag" style="display: none;">${s+1}</span>`)},te=function(){function a(s,n,l,_){s==255?n.text(i.getMessage("initialSetupNotInBuild")):I(t.CONFIG.activeSensors,l)?n.text(_[s]):n.text(i.getMessage("initialSetupNotDetected"))}c.gte(t.CONFIG.apiVersion,O)&&g.send_message(d.MSP2_SENSOR_CONFIG_ACTIVE,!1,!1,function(){a(t.SENSOR_CONFIG_ACTIVE.gyro_hardware,Y,"gyro",p().gyro.elements),a(t.SENSOR_CONFIG_ACTIVE.acc_hardware,K,"acc",p().acc.elements),a(t.SENSOR_CONFIG_ACTIVE.baro_hardware,X,"baro",p().baro.elements),a(t.SENSOR_CONFIG_ACTIVE.mag_hardware,W,"mag",p().mag.elements),a(t.SENSOR_CONFIG_ACTIVE.sonar_hardware,Z,"sonar",p().sonar.elements),c.gte(t.CONFIG.apiVersion,M)&&a(t.SENSOR_CONFIG_ACTIVE.opticalflow_hardware,j,"opticalflow",p().opticalflow.elements)})};function ie(a,s){const n=e(".dialogBuildInfo")[0];e(".dialogBuildInfo-title").html(a),e(".dialogBuildInfo-content").html(s),n.hasAttribute("open")||(n.showModal(),e(".dialogBuildInfo-closebtn").on("click",function(){n.close()}))}const ae=function(){const a=t.CONFIG.buildKey.length===32;if(a&&N()){const s=`https://build.betaflight.com/api/builds/${t.CONFIG.buildKey}`,n=`<span class="buildInfoBtn" title="${i.getMessage("initialSetupInfoBuildConfig")}: ${s}/json">
                                    <a href="${s}/json" target="_blank"><strong>${i.getMessage("initialSetupInfoBuildConfig")}</strong></a></span>`,l=`<span class="buildInfoBtn" title="${i.getMessage("initialSetupInfoBuildLog")}: ${s}/log">
                                    <a href="${s}/log" target="_blank"><strong>${i.getMessage("initialSetupInfoBuildLog")}</strong></a></span>`;h.html(`<span class="buildInfoBtn" title="${i.getMessage("initialSetupInfoBuildOptions")}">
                    <a class="buildOptions" href=#"><strong>${i.getMessage("initialSetupInfoBuildOptionList")}</strong></a></span>`),h.html(`${n} ${l}`)}else h.html(a?i.getMessage("initialSetupNotOnline"):i.getMessage("initialSetupNoBuildInfo"))},se=function(){if((c.eq(t.CONFIG.apiVersion,w)&&N()||c.gte(t.CONFIG.apiVersion,O))&&t.CONFIG.buildOptions.length){let s='<div class="dialogBuildInfoGrid-container">';for(const l of t.CONFIG.buildOptions)s+=`<div class="dialogBuildInfoGrid-item">${l}</div>`;s+="</div>",C.html(`<span class="buildInfoBtn" title="${i.getMessage("initialSetupInfoBuildOptions")}">
                    <a class="buildOptions" href=#"><strong>${i.getMessage("initialSetupInfoBuildOptionList")}</strong></a></span>`);const n=`<span class="buildInfoBtn" title="${i.getMessage("initialSetupInfoBuildOptionList")}">
                                      <a class="buildOptions" href=#"><strong>${i.getMessage("initialSetupInfoBuildOptions")}</strong></a></span>`;C.html(n),e("a.buildOptions").on("click",async function(){ie(`<h3>${i.getMessage("initialSetupInfoBuildOptionList")}</h3>`,s)})}else C.html(`${i.getMessage("initialSetupNoBuildInfo")}`)};function ne(){q.text(t.CONFIG.apiVersion),Q.text(t.CONFIG.buildInfo),c.gte(t.CONFIG.apiVersion,w)&&(J.html(t.CONFIG.buildKey.length===32?i.getMessage("initialSetupInfoBuildCloud"):i.getMessage("initialSetupInfoBuildLocal")),ae(),se())}function oe(){const a=N();let s="";const n=navigator.connection.effectiveType,l=navigator.connection.downlink,_=navigator.connection.rtt;!a||!navigator.onLine||n==="none"?s=i.getMessage("initialSetupNetworkInfoStatusOffline"):n==="slow-2g"||n==="2g"||l<.115||_>1e3?s=i.getMessage("initialSetupNetworkInfoStatusSlow"):s=i.getMessage("initialSetupNetworkInfoStatusOnline"),e(".network-status").text(s),e(".network-type").text(navigator.connection.effectiveType),e(".network-downlink").text(`${navigator.connection.downlink} Mbps`),e(".network-rtt").text(navigator.connection.rtt)}ee(),te(),ne(),oe(),I(t.CONFIG.activeSensors,"sonar")||e(".sonarBox").hide();function le(){e("#initialSetupArmingAllowed").toggle(t.CONFIG.armingDisableFlags===0);for(let _=0;_<t.CONFIG.armingDisableCount;_++)e(`#initialSetupArmingDisableFlags${_}`).css("display",t.CONFIG.armingDisableFlags&1<<_?"inline-block":"none");v.text(i.getMessage("initialSetupBatteryValue",[t.ANALOG.voltage])),L.text(i.getMessage("initialSetupBatteryMahValue",[t.ANALOG.mAhdrawn])),$.text(i.getMessage("initialSetupBatteryAValue",[t.ANALOG.amperage.toFixed(2)])),P.text(i.getMessage("initialSetupRSSIValue",[(t.ANALOG.rssi/1023*100).toFixed(0)])),c.gte(t.CONFIG.apiVersion,O)&&t.CONFIG.cpuTemp?T.html(`${t.CONFIG.cpuTemp.toFixed(0)} &#8451;`):T.text(i.getMessage("initialSetupCpuTempNotSupported")),c.gte(t.CONFIG.apiVersion,M)?R.text(t.MCU_INFO.name):R.parent().hide(),F.text(t.GPS_DATA.fix?i.getMessage("gpsFixTrue"):i.getMessage("gpsFixFalse")),F.toggleClass("ready",t.GPS_DATA.fix!=0),k.text(t.GPS_DATA.numSat);const a=t.GPS_DATA.lat/1e7,s=t.GPS_DATA.lon/1e7,n=`https://maps.google.com/?q=${a},${s}`,l=i.getMessage("gpsPositionUnit");e(".GPS_info td.latLon a").prop("href",n).text(`${a.toFixed(4)} / ${s.toFixed(4)} ${l}`)}function ge(){g.send_message(d.MSP_ATTITUDE,!1,!1,function(){V.text(i.getMessage("initialSetupAttitude",[t.SENSOR_DATA.kinematics[0]])),H.text(i.getMessage("initialSetupAttitude",[t.SENSOR_DATA.kinematics[1]])),z.text(i.getMessage("initialSetupAttitude",[t.SENSOR_DATA.kinematics[2]])),o.renderModel(),o.updateInstruments()}),I(t.CONFIG.activeSensors,"sonar")&&g.send_message(d.MSP_SONAR,!1,!1,function(){U.text(`${t.SENSOR_DATA.sonar.toFixed(1)} cm`)})}r.interval_add("setup_data_pull_fast",ge,33,!0),r.interval_add("setup_data_pull_slow",le,250,!0),r.content_ready(u)}};f.initializeInstruments=function(){const u={size:90,showBox:!1,img_directory:"images/flightindicators/"},o=e.flightIndicator("#attitude","attitude",u),S=e.flightIndicator("#heading","heading",u);this.updateInstruments=function(){o.setRoll(t.SENSOR_DATA.kinematics[0]),o.setPitch(t.SENSOR_DATA.kinematics[1]),S.setHeading(t.SENSOR_DATA.kinematics[2])}};f.initModel=function(){this.model=new re(e(".model-and-info #canvas_wrapper"),e(".model-and-info #canvas")),e(window).on("resize",e.proxy(this.model.resize,this.model))};f.renderModel=function(){const u=t.SENSOR_DATA.kinematics[1]*-1*.017453292519943295,o=(t.SENSOR_DATA.kinematics[2]*-1-this.yaw_fix)*.017453292519943295,S=t.SENSOR_DATA.kinematics[0]*-1*.017453292519943295;this.model.rotateTo(u,o,S)};f.cleanup=function(u){this.model&&(e(window).off("resize",e.proxy(this.model.resize,this.model)),this.model.dispose()),u&&u()};G.setup=f;export{f as setup};
