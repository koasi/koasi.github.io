import{G as I,M as l,$ as e,T as Me,c as h,A as Xe,a as Te,h as re,b as oe,D as De,w as ke,f as ce,d as $,t as le,C as Be}from"./DarkTheme-7d442e55.js";import{a as o,k as ye,v as Ue,F as t,w as L,s as D,q as he,b as Ve,x as ze,m as b}from"./main-04baad83.js";import{R as $e}from"./RateCurve-b2a5ea63.js";import{s as Le,l as de,a as fe,b as _e,c as He}from"./transform-8625d4bb.js";const w={rateChartHeight:117,analyticsChanges:{},needReboot:!1,elrsBindingPhraseEnabled:!1};w.initialize=function(d){const r=this;I.active_tab="receiver";function k(u){return($("binding_phrase_map").binding_phrase_map||{})[u]??0}function B(u,p){const m=$("binding_phrase_map").binding_phrase_map??{};m[u]=p,ce({binding_phrase_map:m})}function me(u){let p=[0,0,0,0,0,0];if(u){const m=`-DMY_BINDING_PHRASE="${u}"`,y=ze.MD5(m).toString().match(/.{1,2}/g).map(g=>parseInt(g,16)),N=new DataView(new ArrayBuffer(6));for(let g=0;g<6;g++)N.setUint8(g,y[g]);p=Array.from(new Uint8Array(N.buffer))}return p}function ge(){l.send_message(o.MSP_RC,!1,!1,pe)}function pe(){l.send_message(o.MSP_RSSI_CONFIG,!1,!1,Re)}function Re(){l.send_message(o.MSP_RC_TUNING,!1,!1,Se)}function Se(){l.send_message(o.MSP_RX_MAP,!1,!1,ve)}function ve(){l.send_message(o.MSP_RC_DEADBAND,!1,!1,Ce)}function Ce(){l.send_message(o.MSP_RX_CONFIG,!1,!1,Fe)}function Fe(){l.send_message(o.MSP_MIXER_CONFIG,!1,!1,be)}function be(){e("#content").load("./tabs/receiver.html",Ie)}l.send_message(o.MSP_FEATURE_CONFIG,!1,!1,ge);function Ie(){self.analyticsChanges={};const u=e(".tab-receiver .features");t.FEATURE_CONFIG.features.generateElements(u),h.localizePage(),e('.deadband input[name="yaw_deadband"]').val(t.RC_DEADBAND_CONFIG.yaw_deadband),e('.deadband input[name="deadband"]').val(t.RC_DEADBAND_CONFIG.deadband),e('.deadband input[name="3ddeadbandthrottle"]').val(t.RC_DEADBAND_CONFIG.deadband3d_throttle),e('.sticks input[name="stick_min"]').val(t.RX_CONFIG.stick_min),e('.sticks input[name="stick_center"]').val(t.RX_CONFIG.stick_center),e('.sticks input[name="stick_max"]').val(t.RX_CONFIG.stick_max);const p=[h.getMessage("controlAxisRoll"),h.getMessage("controlAxisPitch"),h.getMessage("controlAxisYaw"),h.getMessage("controlAxisThrottle")],m=e(".tab-receiver .bars");let H=1;const y=t.RC.active_channels>0?t.RC.active_channels:8;for(let n=0;n<y;n++){let a;n<p.length?a=p[n]:a=h.getMessage(`controlAxisAux${H++}`),m.append(`                <ul>                    <li class="name">${a}</li>                    <li class="meter">                        <div class="meter-bar">                            <div class="label"></div>                            <div class="fill${t.RC.active_channels===0?"disabled":""}">                                <div class="label"></div>                            </div>                        </div>                    </li>                </ul>            `)}const N={min:800,max:2200},g=[];e(".meter .fill",m).each(function(){g.push(e(this))});const P=[];e(".meter",m).each(function(){P.push(e(".label",this))}),r.resize=function(){const n=e(".meter:first",m).width(),a=e(".meter .label:first",m).width(),s=n/2-a/2;for(let c=0;c<P.length;c++)P[c].css("margin-left",s)},e(window).on("resize",r.resize).resize();let M=["A","E","R","T","1","2","3","4"],R=[];for(let n=0;n<t.RC_MAP.length;n++)R[t.RC_MAP[n]]=M[n];const Y=R.join("");e('input[name="rcmap"]').val(Y);const U=Y;e('input[name="rcmap"]').on("input",function(){let n=e(this).val();n.length>8&&(n=n.substr(0,8),e(this).val(n))}),e('input[name="rcmap"]').focusout(function(){const n=e(this).val();R=n.split("");const a=[];if(n.length!==8)return e(this).val(U),!1;for(let s=0;s<n.length;s++){if(M.indexOf(R[s])<0)return e(this).val(U),!1;if(a.indexOf(R[s])<0)a.push(R[s]);else return e(this).val(U),!1}}),e('select[name="rcmap_helper"]').val(0),e('select[name="rcmap_helper"]').change(function(){e('input[name="rcmap"]').val(e(this).val())});const K=e('select[name="rssi_channel"]');K.append(`<option value="0">${h.getMessage("receiverRssiChannelDisabledOption")}</option>`);for(let n=5;n<t.RC.active_channels+1;n++){const a=`controlAxisAux${n-4}`;K.append(`<option value="${n}">${h.getMessage(a)}</option>`)}e('select[name="rssi_channel"]').val(t.RSSI_CONFIG.channel);const W=t.getSupportedSerialRxTypes(),E=e("select.serialRX");let q=!0;t.getSerialRxTypes().forEach((n,a)=>{const s=W.includes(n);s||(q=!1);const c=s?"":"disabled";E.append(`<option value="${a}" ${c} >${n}</option>`)});const j=function(){const n=parseInt(e("select.serialRX").val()),a=t.getSerialRxTypes()[n],s=W.includes(a);e(".someRXTypesDisabled").toggle(s&&!q),e(".serialRXNotSupported").toggle(!s)};E.change(function(){const n=parseInt(e(this).val());let a;n!==t.RX_CONFIG.serialrx_provider&&(a=e(this).find("option:selected").text(),x(!0)),r.analyticsChanges.SerialRx=a,t.RX_CONFIG.serialrx_provider=n,j()}),E.val(t.RX_CONFIG.serialrx_provider),j(),D.gte(t.CONFIG.apiVersion,Xe)?E.sortSelect("NONE").select2():E.sortSelect().select2(),e(document).on("select2:open","select.serialRX",()=>{const n=document.querySelectorAll(".select2-container--open .select2-search__field");e(this).one("mouseup keyup",()=>{setTimeout(()=>{n[n.length-1].focus()},0)})});const J=["NRF24_V202_250K","NRF24_V202_1M","NRF24_SYMA_X","NRF24_SYMA_X5C","NRF24_CX10","CX10A","NRF24_H8_3D","NRF24_INAV","FRSKY_D","FRSKY_X","A7105_FLYSKY","A7105_FLYSKY_2A","NRF24_KN","SFHSS","SPEKTRUM","FRSKY_X_LBT","REDPINE","FRSKY_X_V2","FRSKY_X_LBT_V2","EXPRESSLRS"],X=e("select.spiRx");for(let n=0;n<J.length;n++)X.append(`<option value="${n}">${J[n]}</option>`);if(X.change(function(){const n=parseInt(e(this).val());let a;n!==t.RX_CONFIG.rxSpiProtocol&&(a=e(this).find("option:selected").text(),x(!0)),r.analyticsChanges.SPIRXProtocol=a,t.RX_CONFIG.rxSpiProtocol=n}),X.val(t.RX_CONFIG.rxSpiProtocol),X.sortSelect().select2(),e(document).on("select2:open","select.spiRx",()=>{const n=document.querySelectorAll(".select2-container--open .select2-search__field");e(this).one("mouseup keyup",()=>{setTimeout(()=>{n[n.length-1].focus()},0)})}),t.FEATURE_CONFIG.features.isEnabled("RX_SPI")&&t.RX_CONFIG.rxSpiProtocol==19&&D.gte(t.CONFIG.apiVersion,Te)){r.elrsBindingPhraseEnabled=!0;const n=e("span.elrsUid"),a=t.RX_CONFIG.elrsUid.join(",");n.text(a);const s=e("input.elrsBindingPhrase"),c=k(a);c&&s.val(c),s.on("keyup",function(){const _=s.val();_?n.text(me(_)):n.text("0.0.0.0.0.0"),x(!0)})}else r.elrsBindingPhraseEnabled=!1;r.elrsBindingPhraseEnabled&&D.gte(t.CONFIG.apiVersion,re)?e('input[name="elrsModelId-number"]').val(t.RX_CONFIG.elrsModelId):e('input[name="elrsModelId-number"]').parent().hide();function x(n=!1){n&&(r.needReboot=!0),r.needReboot?(e(".update_btn").hide(),e(".save_btn").show()):(e(".update_btn").show(),e(".save_btn").hide())}e("input.feature",u).change(function(){const n=e(this);t.FEATURE_CONFIG.features.updateData(n),he(t.FEATURE_CONFIG.features),(n.attr("name")==="RSSI_ADC"||n.attr("name")==="TELEMETRY")&&x(!0)});function Q(){e("div.serialRXBox").toggle(t.FEATURE_CONFIG.features.isEnabled("RX_SERIAL"))}function Z(){e("div.spiRxBox").toggle(t.FEATURE_CONFIG.features.isEnabled("RX_SPI"))}function ee(){e("#elrsContainer").toggle(r.elrsBindingPhraseEnabled),e("input.elrsUid").toggle(r.elrsBindingPhraseEnabled)}e("#rxModeSelect").sortSelect(h.getMessage("featureNone")),e(u).filter("select").change(function(){const n=e(this);t.FEATURE_CONFIG.features.updateData(n),he(t.FEATURE_CONFIG.features),n.attr("name")==="rxMode"&&(Q(),Z(),ee(),x(!0))}),Q(),Z(),ee(),x(),e("a.refresh").click(function(){r.refresh(function(){oe(h.getMessage("receiverDataRefreshed"))})});function te(n=!1){t.RX_CONFIG.stick_max=parseInt(e('.sticks input[name="stick_max"]').val()),t.RX_CONFIG.stick_center=parseInt(e('.sticks input[name="stick_center"]').val()),t.RX_CONFIG.stick_min=parseInt(e('.sticks input[name="stick_min"]').val()),t.RC_DEADBAND_CONFIG.yaw_deadband=parseInt(e('.deadband input[name="yaw_deadband"]').val()),t.RC_DEADBAND_CONFIG.deadband=parseInt(e('.deadband input[name="deadband"]').val()),t.RC_DEADBAND_CONFIG.deadband3d_throttle=e('.deadband input[name="3ddeadbandthrottle"]').val(),M=["A","E","R","T","1","2","3","4"],R=e('input[name="rcmap"]').val().split("");for(let f=0;f<t.RC_MAP.length;f++)t.RC_MAP[f]=R.indexOf(M[f]);if(t.RSSI_CONFIG.channel=parseInt(e('select[name="rssi_channel"]').val()),t.RX_CONFIG.rcSmoothingSetpointCutoff=parseInt(e('input[name="rcSmoothingSetpointHz-number"]').val()),t.RX_CONFIG.rcSmoothingFeedforwardCutoff=parseInt(e('input[name="rcSmoothingFeedforwardCutoff-number"]').val()),t.RX_CONFIG.rcSmoothingAutoFactor=parseInt(e('input[name="rcSmoothingAutoFactor-number"]').val()),r.elrsBindingPhraseEnabled){const f=e("span.elrsUid")[0].innerText.split(",").map(C=>parseInt(C,10));if(f.length===6){t.RX_CONFIG.elrsUid=f;const C=e("span.elrsUid")[0].innerText,F=e("input.elrsBindingPhrase").val();B(C,F)}else t.RX_CONFIG.elrsUid=[0,0,0,0,0,0];D.gte(t.CONFIG.apiVersion,re)&&(t.RX_CONFIG.elrsModelId=parseInt(e('input[name="elrsModelId-number"]').val()))}function a(){l.send_message(o.MSP_SET_RSSI_CONFIG,b.crunch(o.MSP_SET_RSSI_CONFIG),!1,s)}function s(){l.send_message(o.MSP_SET_RC_DEADBAND,b.crunch(o.MSP_SET_RC_DEADBAND),!1,c)}function c(){const f=n?_:v;l.send_message(o.MSP_SET_RX_CONFIG,b.crunch(o.MSP_SET_RX_CONFIG),!1,f)}function _(){l.send_message(o.MSP_SET_FEATURE_CONFIG,b.crunch(o.MSP_SET_FEATURE_CONFIG),!1,v)}function v(){b.writeConfiguration(n)}le.sendSaveAndChangeEvents(le.EVENT_CATEGORIES.FLIGHT_CONTROLLER,r.analyticsChanges,"receiver"),r.analyticsChanges={},l.send_message(o.MSP_SET_RX_MAP,b.crunch(o.MSP_SET_RX_MAP),!1,a)}e("a.update").click(function(){te(!1)}),e("a.save").click(function(){te(!0),r.needReboot=!1}),e("a.sticks").on("click",function(){const s=function(_){return Be.connectionValid&&I.active_tab!=="cli"?(b.setRawRx(_),!0):!1},c=open("/receiver_msp/receiver_msp.html","receiver_msp",`location=no,width=370,height=${550+(window.screen.height-window.screen.availHeight)}`);c.setRawRx=s,De.isDarkThemeEnabled(function(_){ke.passValue(c,"darkTheme",_)})});let ne=!1;ne=Ve(t.CONFIG.targetCapabilities,t.TARGET_CAPABILITIES_FLAGS.SUPPORTS_RX_BIND),e("a.bind").click(function(){l.send_message(o.MSP2_BETAFLIGHT_BIND),oe(h.getMessage("receiverButtonBindMessage"))}),e(".bind_btn").toggle(ne);const we=t.RX_CONFIG.rcSmoothingMode;e(".tab-receiver .rcSmoothing").show();const ae=e('select[name="rcSmoothing-select"]');ae.change(function(){t.RX_CONFIG.rcSmoothingMode=parseFloat(e(this).val()),ue()}),ae.val(we);const V=e('input[name="rcSmoothingSetpointHz-number"]'),z=e('input[name="rcSmoothingFeedforwardCutoff-number"]');V.val(t.RX_CONFIG.rcSmoothingSetpointCutoff),z.val(t.RX_CONFIG.rcSmoothingFeedforwardCutoff),e(".tab-receiver .rcSmoothing-setpoint-cutoff").show(),e('select[name="rcSmoothing-setpoint-manual-select"]').val("1"),t.RX_CONFIG.rcSmoothingSetpointCutoff===0&&(e(".tab-receiver .rcSmoothing-setpoint-cutoff").hide(),e('select[name="rcSmoothing-setpoint-manual-select"]').val("0")),e('select[name="rcSmoothing-setpoint-manual-select"]').change(function(){e(this).val()==="0"&&(V.val(0),e(".tab-receiver .rcSmoothing-setpoint-cutoff").hide()),e(this).val()==="1"&&(V.val(t.RX_CONFIG.rcSmoothingSetpointCutoff),e(".tab-receiver .rcSmoothing-setpoint-cutoff").show())}).change(),e(".tab-receiver .rcSmoothing-feedforward-cutoff").show(),e('select[name="rcSmoothing-feedforward-select"]').val("1"),t.RX_CONFIG.rcSmoothingFeedforwardCutoff===0&&(e('select[name="rcSmoothing-feedforward-select"]').val("0"),e(".tab-receiver .rcSmoothing-feedforward-cutoff").hide()),e('select[name="rcSmoothing-feedforward-select"]').change(function(){e(this).val()==="0"&&(e(".tab-receiver .rcSmoothing-feedforward-cutoff").hide(),z.val(0)),e(this).val()==="1"&&(e(".tab-receiver .rcSmoothing-feedforward-cutoff").show(),z.val(t.RX_CONFIG.rcSmoothingFeedforwardCutoff))}).change(),e('select[name="rcSmoothing-setpoint-manual-select"], select[name="rcSmoothing-feedforward-select"]').change(function(){e('select[name="rcSmoothing-setpoint-manual-select"]').val()==="0"||e('select[name="rcSmoothing-feedforward-select"]').val()==="0"?e(".tab-receiver .rcSmoothing-auto-factor").show():e(".tab-receiver .rcSmoothing-auto-factor").hide()}),e('select[name="rcSmoothing-setpoint-manual-select"]').change(),e('input[name="rcSmoothingAutoFactor-number"]').val(t.RX_CONFIG.rcSmoothingAutoFactor),e(".receiverRcSmoothingAutoFactorHelp").attr("title",h.getMessage("receiverRcSmoothingAutoFactorHelp2")),ue(),e(".sticks_btn").toggle(t.FEATURE_CONFIG.features.isEnabled("RX_MSP"));const S={ch1:[],ch2:[],ch3:[],ch4:[]};e(".plot_control .ch1, .plot_control .ch2, .plot_control .ch3, .plot_control .ch4").each(function(){const n=e(this);n.hasClass("ch1")?S.ch1.push(n):n.hasClass("ch2")?S.ch2.push(n):n.hasClass("ch3")?S.ch3.push(n):n.hasClass("ch4")&&S.ch4.push(n)});let A;const T=e('select[name="rx_refresh_rate"]');e("a.reset_rate").click(function(){A=50,T.val(A).change()}),T.change(function(){A=parseInt(e(this).val(),10),ce({rx_refresh_rate:A});function n(){l.send_message(o.MSP_RC,!1,!1,xe)}const a=new Array(t.RC.active_channels);for(let G=0;G<a.length;G++)a[G]=[];let s=0;const c=Le("svg"),_=e("#RX_plot"),v={top:20,right:0,bottom:10,left:40};let f,C,F,O;function Ne(){f=_.width()-v.left-v.right,C=_.height()-v.top-v.bottom,F.range([0,f]),O.range([C,0])}function xe(){if(t.RC.active_channels>0){for(let i=0;i<t.RC.active_channels;i++)g[i].css("width",`${((t.RC.channels[i]-N.min)/(N.max-N.min)*100).clamp(0,100)}%`),P[i].text(t.RC.channels[i]);S.ch1[0].text(t.RC.channels[0]),S.ch2[0].text(t.RC.channels[1]),S.ch3[0].text(t.RC.channels[2]),S.ch4[0].text(t.RC.channels[3]);for(let i=0;i<t.RC.active_channels;i++)a[i].push([s,t.RC.channels[i]]);for(;a[0].length>300;)for(let i=0;i<a.length;i++)a[i].shift()}F=de().domain([s-299,s]),O=de().domain([800,2200]),Ne();const G=fe().scale(F).tickSize(-C).tickFormat(""),Ee=_e().scale(O).tickSize(-f).tickFormat(""),Ae=fe().scale(F).tickFormat(function(i){return i}),Oe=_e().scale(O).tickFormat(function(i){return i}),Ge=He().x(function(i){return F(i[0])}).y(function(i){return O(i[1])});c.select(".x.grid").call(G),c.select(".y.grid").call(Ee),c.select(".x.axis").call(Ae),c.select(".y.axis").call(Oe);const ie=c.select("g.data").selectAll("path").data(a,function(i,Pe){return Pe});ie.enter().append("path").attr("class","line"),ie.attr("d",Ge),s++}I.interval_remove("receiver_pull"),I.interval_add("receiver_pull",n,A,!0)});const se=$("rx_refresh_rate");se.rxRefreshRate?T.val(se.rxRefreshRate).change():T.change(),r.initModelPreview(),r.renderModel(),I.interval_add("receiver_pull_for_model_preview",r.getReceiverData,33,!1),I.content_ready(d)}};w.getReceiverData=function(){l.send_message(o.MSP_RC,!1,!1)};w.initModelPreview=function(){this.keepRendering=!0,this.model=new ye(e(".model_preview"),e(".model_preview canvas")),this.rateCurve=new $e(!1),this.currentRates=this.rateCurve.getCurrentRates(),e(window).on("resize",e.bind(this.model.resize,this.model))};w.renderModel=function(){if(this.keepRendering&&(requestAnimationFrame(this.renderModel.bind(this)),this.clock||(this.clock=new Ue),t.RC.channels[0]&&t.RC.channels[1]&&t.RC.channels[2])){const d=this.clock.getDelta(),r=d*this.rateCurve.rcCommandRawToDegreesPerSecond(t.RC.channels[0],this.currentRates.roll_rate,this.currentRates.rc_rate,this.currentRates.rc_expo,this.currentRates.superexpo,this.currentRates.deadband,this.currentRates.roll_rate_limit),k=d*this.rateCurve.rcCommandRawToDegreesPerSecond(t.RC.channels[1],this.currentRates.pitch_rate,this.currentRates.rc_rate_pitch,this.currentRates.rc_pitch_expo,this.currentRates.superexpo,this.currentRates.deadband,this.currentRates.pitch_rate_limit),B=d*this.rateCurve.rcCommandRawToDegreesPerSecond(t.RC.channels[2],this.currentRates.yaw_rate,this.currentRates.rc_rate_yaw,this.currentRates.rc_yaw_expo,this.currentRates.superexpo,this.currentRates.yawDeadband,this.currentRates.yaw_rate_limit);this.model.rotateBy(-L(k),-L(B),-L(r))}};w.cleanup=function(d){this.keepRendering=!1,e(window).off("resize",this.resize),this.model&&(e(window).off("resize",e.proxy(this.model.resize,this.model)),this.model.dispose()),d&&d()};w.refresh=function(d){const r=this;I.tab_switch_cleanup(function(){r.initialize(),d&&d()})};function ue(){const d=t.RX_CONFIG.rcSmoothingMode;e(".tab-receiver .rcSmoothing-feedforward-cutoff").show(),e(".tab-receiver .rcSmoothing-setpoint-cutoff").show(),e(".tab-receiver .rcSmoothing-feedforward-manual").show(),e(".tab-receiver .rcSmoothing-setpoint-manual").show(),(t.RX_CONFIG.rcSmoothingFeedforwardCutoff===0||t.RX_CONFIG.rcSmoothingSetpointCutoff===0)&&e(".tab-receiver .rcSmoothing-auto-factor").show(),e(".tab-receiver .rcSmoothingOff").text(h.getMessage("off")),e(".tab-receiver .rcSmoothingOn").text(h.getMessage("on")),d===0&&(e(".tab-receiver .rcSmoothing-feedforward-cutoff").hide(),e(".tab-receiver .rcSmoothing-setpoint-cutoff").hide(),e(".tab-receiver .rcSmoothing-feedforward-manual").hide(),e(".tab-receiver .rcSmoothing-setpoint-manual").hide(),e(".tab-receiver .rcSmoothing-auto-factor").hide()),t.RX_CONFIG.rcSmoothingFeedforwardCutoff===0&&e(".tab-receiver .rcSmoothing-feedforward-cutoff").hide(),t.RX_CONFIG.rcSmoothingSetpointCutoff===0&&e(".tab-receiver .rcSmoothing-setpoint-cutoff").hide()}Me.receiver=w;export{w as receiver};
