import{G as b,C as M,M as i,a as N,$ as e,c as l,t as _,T as ee,b as z,d as G}from"./DarkTheme-7d442e55.js";import{a as d,s as k,F as a,m as c,n as ae,K as se,e as S,N as y}from"./main-04baad83.js";import{g as oe}from"./generate_filename-2109a26f.js";import{D as T}from"./debug-fc3199df.js";let A;const m={blockSize:128,writeError:!1,BLOCK_SIZE:4096};m.initialize=function(p){const u=this;let D,R;b.active_tab!=="onboard_logging"&&(b.active_tab="onboard_logging"),M.connectionValid&&i.send_message(d.MSP_FEATURE_CONFIG,!1,!1,function(){i.send_message(d.MSP_DATAFLASH_SUMMARY,!1,!1,function(){i.send_message(d.MSP_SDCARD_SUMMARY,!1,!1,function(){i.send_message(d.MSP_BLACKBOX_CONFIG,!1,!1,function(){i.send_message(d.MSP_ADVANCED_CONFIG,!1,!1,function(){k.gte(a.CONFIG.apiVersion,N)?i.send_message(d.MSP2_GET_TEXT,c.crunch(d.MSP2_GET_TEXT,d.CRAFT_NAME),!1,O):i.send_message(d.MSP_NAME,!1,!1,O)})})})})});function L(s,o){return o===0?s:L(o,s%o)}function O(){e("#content").load("./tabs/onboard_logging.html",function(){l.localizePage();const s=a.DATAFLASH.totalSize>0;let o;a.BLACKBOX.supported||a.DATAFLASH.supported||a.FEATURE_CONFIG.features.isEnabled("BLACKBOX")?o="yes":o="no",e(".tab-onboard_logging").addClass("serial-supported").toggleClass("dataflash-supported",a.DATAFLASH.supported).toggleClass("dataflash-present",s).toggleClass("sdcard-supported",a.SDCARD.supported).toggleClass("blackbox-config-supported",a.BLACKBOX.supported).toggleClass("blackbox-supported",o==="yes").toggleClass("blackbox-maybe-supported",o==="maybe").toggleClass("blackbox-unsupported",o==="no"),s&&(e(".tab-onboard_logging a.erase-flash").click(W),e(".tab-onboard_logging a.erase-flash-confirm").click(j),e(".tab-onboard_logging a.erase-flash-cancel").click(J),e(".tab-onboard_logging a.save-flash").click(q),e(".tab-onboard_logging a.save-flash-cancel").click(V),e(".tab-onboard_logging a.save-flash-dismiss").click(F));const t=e(".blackboxDevice select"),n=e(".blackboxRate select"),g=e(".blackboxDebugMode select"),f=e(".blackboxDebugFields select");a.BLACKBOX.supported&&e(".tab-onboard_logging a.save-settings").on("click",async function(){if(k.gte(a.CONFIG.apiVersion,N)){let r=0;e(".blackboxDebugFields select option:not(:selected)").each(function(){r|=1<<e(this).val()}),a.BLACKBOX.blackboxDisabledMask=r}a.BLACKBOX.blackboxSampleRate=parseInt(n.val(),10),a.BLACKBOX.blackboxPDenom=parseInt(n.val(),10),a.BLACKBOX.blackboxDevice=parseInt(t.val(),10),await i.promise(d.MSP_SET_BLACKBOX_CONFIG,c.crunch(d.MSP_SET_BLACKBOX_CONFIG)),a.PID_ADVANCED_CONFIG.debugMode=parseInt(g.val()),await i.promise(d.MSP_SET_ADVANCED_CONFIG,c.crunch(d.MSP_SET_ADVANCED_CONFIG)),c.writeConfiguration(!0)}),K(n),H(t),$(g),X(f),t.change(function(){e(this).val()==="0"?e("div.blackboxRate").hide():e("div.blackboxRate").show()}).change(),(a.SDCARD.supported&&t.val()==2||a.DATAFLASH.supported&&t.val()==1)&&(e(".tab-onboard_logging").toggleClass("msc-supported",!0),e("a.onboardLoggingRebootMsc").click(function(){_.sendEvent(_.EVENT_CATEGORIES.FLIGHT_CONTROLLER,"RebootMsc");const r=[];b.operating_system==="Linux"?r.push(c.REBOOT_TYPES.MSC_UTC):r.push(c.REBOOT_TYPES.MSC),i.send_message(d.MSP_SET_REBOOT,r,!1)})),E(),b.content_ready(p)})}function H(s){s.empty(),s.append(`<option value="0">${l.getMessage("blackboxLoggingNone")}</option>`),a.DATAFLASH.supported&&s.append(`<option value="1">${l.getMessage("blackboxLoggingFlash")}</option>`),a.SDCARD.supported&&s.append(`<option value="2">${l.getMessage("blackboxLoggingSdCard")}</option>`),s.append(`<option value="3">${l.getMessage("blackboxLoggingSerial")}</option>`),s.val(a.BLACKBOX.blackboxDevice)}function K(s){const o=a.CONFIG.sampleRateHz/a.PID_ADVANCED_CONFIG.pid_process_denom,t=5;for(let n=0;n<t;n++){let g=Math.round(o/2**n),f="Hz";L(g,1e3)===1e3&&(g/=1e3,f="kHz"),s.append(`<option value="${n}">1/${2**n} (${g}${f})</option>`)}s.val(a.BLACKBOX.blackboxSampleRate)}function $(s){e(".blackboxDebugMode").show();for(let o=0;o<a.PID_ADVANCED_CONFIG.debugModeCount;o++)o<T.modes.length?s.append(new Option(T.modes[o],o)):s.append(new Option(l.getMessage("onboardLoggingDebugModeUnknown"),o));s.val(a.PID_ADVANCED_CONFIG.debugMode).select2().sortSelect("NONE")}function X(s){if(k.gte(a.CONFIG.apiVersion,N)){e(".blackboxDebugFields").show();let o=a.BLACKBOX.blackboxDisabledMask;for(let t=0;t<T.enableFields.length;t++){const n=(o&1<<t)===0;s.append(new Option(T.enableFields[t],t,!1,n))}s.sortSelect().multipleSelect()}else e(".blackboxDebugFields").hide()}function v(s){if(s<1024)return`${Math.round(s)}kB`;const o=s/1024;let t;return o<900?`${o.toFixed(1)}MB`:(t=o/1024,`${t.toFixed(1)}GB`)}function U(s){return s<1024?`${s}B`:v(s/1024)}function C(s,o,t,n,g){o>0?(s.css({width:`${o/t*100}%`,display:"block"}),e("div",s).text((n?`${n} `:"")+(g?v(o):U(o)))):s.css({display:"none"})}e('input[name="expertModeCheckbox"]').on("change",()=>e("a.regular-button.require-msc-supported.save-flash").toggle(ae()));function E(){const s=a.DATAFLASH.totalSize>0;C(e(".tab-onboard_logging .dataflash-used"),a.DATAFLASH.usedSize,a.DATAFLASH.totalSize,l.getMessage("dataflashUsedSpace"),!1),C(e(".tab-onboard_logging .dataflash-free"),a.DATAFLASH.totalSize-a.DATAFLASH.usedSize,a.DATAFLASH.totalSize,l.getMessage("dataflashFreeSpace"),!1),C(e(".tab-onboard_logging .sdcard-other"),a.SDCARD.totalSizeKB-a.SDCARD.freeSizeKB,a.SDCARD.totalSizeKB,l.getMessage("dataflashUnavSpace"),!0),C(e(".tab-onboard_logging .sdcard-free"),a.SDCARD.freeSizeKB,a.SDCARD.totalSizeKB,l.getMessage("dataflashLogsSpace"),!0),e("a.regular-button erase-flash, a.regular-button.require-msc-supported.save-flash").toggleClass("disabled",a.DATAFLASH.usedSize===0),e(".tab-onboard_logging").toggleClass("sdcard-error",a.SDCARD.state===i.SDCARD_STATE_FATAL).toggleClass("sdcard-initializing",a.SDCARD.state===i.SDCARD_STATE_CARD_INIT||a.SDCARD.state===i.SDCARD_STATE_FS_INIT).toggleClass("sdcard-ready",a.SDCARD.state===i.SDCARD_STATE_READY);const o=s||a.SDCARD.state===i.SDCARD_STATE_READY;e(".tab-onboard_logging").toggleClass("msc-not-ready",!o),o?e("a.onboardLoggingRebootMsc").removeClass("disabled"):e("a.onboardLoggingRebootMsc").addClass("disabled");let t;switch(a.SDCARD.state){case i.SDCARD_STATE_NOT_PRESENT:e(".sdcard-status").text(l.getMessage("sdcardStatusNoCard")),t="SdCard: NotPresent";break;case i.SDCARD_STATE_FATAL:e(".sdcard-status").html(l.getMessage("sdcardStatusReboot")),t="SdCard: Error";break;case i.SDCARD_STATE_READY:e(".sdcard-status").text(l.getMessage("sdcardStatusReady")),t="SdCard: Ready";break;case i.SDCARD_STATE_CARD_INIT:e(".sdcard-status").text(l.getMessage("sdcardStatusStarting")),t="SdCard: Init";break;case i.SDCARD_STATE_FS_INIT:e(".sdcard-status").text(l.getMessage("sdcardStatusFileSystem")),t="SdCard: FsInit";break;default:e(".sdcard-status").text(l.getMessage("sdcardStatusUnknown",[a.SDCARD.state]))}s&&a.SDCARD.state===i.SDCARD_STATE_NOT_PRESENT&&(t="Dataflash"),_.sendEvent(_.EVENT_CATEGORIES.FLIGHT_CONTROLLER,"DataLogging",{logSize:a.DATAFLASH.usedSize,logStatus:t}),a.SDCARD.supported&&!A&&(A=setTimeout(function(){A=!1,M.connectionValid&&i.send_message(d.MSP_SDCARD_SUMMARY,!1,!1,function(){E()})},2e3))}function V(){D=!0}function Y(){e(".dataflash-saving progress").attr("value",0),D=!1,e(".dataflash-saving").removeClass("done"),e(".dataflash-saving")[0].showModal()}function F(){e(".dataflash-saving")[0].close()}function B(s,o,t){_.sendEvent(_.EVENT_CATEGORIES.FLIGHT_CONTROLLER,"SaveDataflash");const n=(new Date().getTime()-s)/1e3;console.log(`Received ${o} bytes in ${n.toFixed(2)}s (${(o/n/1024).toFixed(2)}kB / s) with block size ${u.blockSize}.`),isNaN(t)||console.log("Compressed into",t,"bytes with mean compression factor of",o/t),e(".dataflash-saving").addClass("done"),G("showNotifications").showNotifications&&y.showNotification("Betaflight Configurator",{body:l.getMessage("flashDownloadDoneNotification"),icon:"/images/pwa/favicon.ico"})}function I(s){i.send_message(d.MSP_DATAFLASH_SUMMARY,!1,!1,function(){E(),s&&s()})}function q(){b.connected_to&&(u.blockSize=u.BLOCK_SIZE,I(function(){const s=a.DATAFLASH.usedSize;let o;Z(function(t){let n=0,g=0;Y();function f(P,h,w){if(h!==null)if(h.byteLength>0){n+=h.byteLength,isNaN(w)||isNaN(g)?g=null:g+=w,e(".dataflash-saving progress").attr("value",n/s*100);const Q=new Blob([h]);S.writeChunck(o,Q).then(()=>{D||n>=s?(D?F():B(r,n,g),S.closeFile(o)):u.writeError?(F(),S.closeFile(o)):c.dataflashRead(n,u.blockSize,f)})}else B(r,n,g),S.closeFile(o);else c.dataflashRead(n,u.blockSize,f)}const r=new Date().getTime();S.openFile(t).then(P=>{o=P,c.dataflashRead(n,u.blockSize,f)})})}))}function Z(s){const o="BLACKBOX_LOG",t="BBL",n=oe(o,t);S.pickSaveFile(n,l.getMessage("fileSystemPickerFiles",{typeof:t}),`.${t}`).then(g=>{console.log("File picked:",g),s(g)}).then(()=>{console.log("FINISHED")}).catch(g=>{console.error("Error saving blackbox file:",g),z(l.getMessage("dataflashFileWriteFailed")),z(`<strong><span class="message-negative">${l.getMessage("error",{errorMessage:g})}</span class="message-negative></strong>`)})}function W(){R=!1,e(".dataflash-confirm-erase").removeClass("erasing"),e(".dataflash-confirm-erase")[0].showModal()}function x(){I(function(){M.connectionValid&&!R&&(a.DATAFLASH.ready?(e(".dataflash-confirm-erase")[0].close(),G("showNotifications").showNotifications&&y.showNotification("Betaflight Configurator",{body:l.getMessage("flashEraseDoneNotification"),icon:"/images/pwa/favicon.ico"})):setTimeout(x,500))})}function j(){e(".dataflash-confirm-erase").addClass("erasing"),i.send_message(d.MSP_DATAFLASH_ERASE,!1,!1,x)}function J(){R=!0,e(".dataflash-confirm-erase")[0].close()}};m.cleanup=function(p){A&&(clearTimeout(A),A=!1),p&&p()};m.mscRebootFailedCallback=function(){e(".tab-onboard_logging").toggleClass("msc-supported",!1),se(l.getMessage("operationNotSupported"))};ee.onboard_logging=m;export{m as onboard_logging};
