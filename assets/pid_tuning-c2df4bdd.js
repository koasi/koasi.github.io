import{$ as e,h as We,M as y,G as Re,a as z,T as Ue,c as F,b as ve,t as Qe}from"./DarkTheme-7d442e55.js";import{F as t,n as et,s as P,a as h,m as K,t as He,k as tt,v as it,w as Xe,l as rt}from"./main-04baad83.js";import{R as at}from"./RateCurve-b2a5ea63.js";const Ke={redWhiteGreen:[{percentage:-1,color:{r:255,g:0,b:0,a:1}},{percentage:0,color:{r:255,g:255,b:255,a:1}},{percentage:1,color:{r:0,g:255,b:0,a:1}}],pidSlider:[{percentage:-1,color:{r:197,g:197,b:197,a:1}},{percentage:0,color:{r:255,g:255,b:255,a:0}},{percentage:1,color:{r:255,g:84,b:14,a:1}}]};function nt(r,i=null){i=i||Ke.redWhiteGreen,r=Math.min(1,Math.max(-1,r));let o;for(o=1;o<i.length-1&&!(r<i[o].percentage);o++);const c=i[o-1],g=i[o],n=g.percentage-c.percentage,R=(r-c.percentage)/n,_=1-R,p=R,E={r:Math.floor(c.color.r*_+g.color.r*p),g:Math.floor(c.color.g*_+g.color.g*p),b:Math.floor(c.color.b*_+g.color.b*p),a:c.color.a*_+g.color.a*p};return`rgba(${[E.r,E.g,E.b,E.a].join(",")})`}const s={sliderPidsMode:2,sliderDGain:1,sliderPIGain:1,sliderFeedforwardGain:1,sliderDMaxGain:1,sliderIGain:1,sliderRollPitchRatio:1,sliderPitchPIGain:1,sliderMasterMultiplier:1,pidSlidersUnavailable:!1,GyroSliderUnavailable:!1,DTermSliderUnavailable:!1,sliderGyroFilter:1,sliderGyroFilterMultiplier:1,sliderDTermFilter:1,sliderDTermFilterMultiplier:1,dMaxFeatureEnabled:!0,defaultPDRatio:0,PID_DEFAULT:[],FILTER_DEFAULT:{},SLIDER_DEFAULT:{},NON_EXPERT_SLIDER_MIN:70,NON_EXPERT_SLIDER_MAX:140,NON_EXPERT_SLIDER_MIN_GYRO:50,NON_EXPERT_SLIDER_MAX_GYRO:150,NON_EXPERT_SLIDER_MIN_DTERM:80,NON_EXPERT_SLIDER_MAX_DTERM:120,cachedPidSliderValues:!1,cachedGyroSliderValues:!1,cachedDTermSliderValues:!1,expertMode:!1};s.initialize=function(){this.PID_DEFAULT=t.getPidDefaults(),this.FILTER_DEFAULT=t.getFilterDefaults(),this.SLIDER_DEFAULT=t.getSliderDefaults(),this.setExpertMode(et()),this.cachedPidSliderValues=!1,this.cachedGyroSliderValues=!1,this.cachedDTermSliderValues=!1,this.initPidSlidersPosition(),this.initGyroFilterSliderPosition(),this.initDTermFilterSliderPosition(),this.validateTuningSliders(),this.updatePidSlidersDisplay(),this.updateGyroFilterSliderDisplay(),this.updateDTermFilterSliderDisplay(),this.updateFilterSlidersWarning(),e(".subtab-pid .slidersDisabled").hide(),e(".subtab-filter .slidersDisabled").hide()};s.updateExpertModePidSlidersDisplay=function(){const r=t.TUNING_SLIDERS.slider_d_gain<this.NON_EXPERT_SLIDER_MIN||t.TUNING_SLIDERS.slider_d_gain>this.NON_EXPERT_SLIDER_MAX,i=t.TUNING_SLIDERS.slider_pi_gain<this.NON_EXPERT_SLIDER_MIN||t.TUNING_SLIDERS.slider_pi_gain>this.NON_EXPERT_SLIDER_MAX,o=t.TUNING_SLIDERS.slider_feedforward_gain<this.NON_EXPERT_SLIDER_MIN||t.TUNING_SLIDERS.slider_feedforward_gain>this.NON_EXPERT_SLIDER_MAX,c=t.TUNING_SLIDERS.slider_dmax_gain!==t.DEFAULT_TUNING_SLIDERS.slider_dmax_gain,g=t.TUNING_SLIDERS.slider_i_gain!==t.DEFAULT_TUNING_SLIDERS.slider_i_gain,n=t.TUNING_SLIDERS.slider_roll_pitch_ratio!==t.DEFAULT_TUNING_SLIDERS.slider_roll_pitch_ratio,R=t.TUNING_SLIDERS.slider_pitch_pi_gain!==t.DEFAULT_TUNING_SLIDERS.slider_pitch_pi_gain,_=t.TUNING_SLIDERS.slider_master_multiplier!==t.DEFAULT_TUNING_SLIDERS.slider_master_multiplier,p=r||i||o,E=c||g||n||R||_;e(".baseSliderDGain").toggleClass("disabledSliders",!this.sliderPidsMode||r&&!this.expertMode),e(".baseSliderPIGain").toggleClass("disabledSliders",!this.sliderPidsMode||i&&!this.expertMode),e(".baseSliderFeedforwardGain").toggleClass("disabledSliders",!this.sliderPidsMode||o&&!this.expertMode),e(".advancedSlider").toggleClass("disabledSliders",!this.sliderPidsMode||!this.expertMode),e(".advancedSliderDmaxGain").toggle(c||this.expertMode),e(".advancedSliderIGain").toggle(g||this.expertMode),e(".advancedSliderRollPitchRatio").toggle(n||this.expertMode),e(".advancedSliderPitchPIGain").toggle(R||this.expertMode),e(".advancedSliderMaster").toggle(_||this.expertMode),e("#sliderDGain").prop("disabled",!this.sliderPidsMode||r&&!this.expertMode),e("#sliderPIGain").prop("disabled",!this.sliderPidsMode||i&&!this.expertMode),e("#sliderFeedforwardGain").prop("disabled",!this.sliderPidsMode||o&&!this.expertMode),e("#sliderDMaxGain").prop("disabled",!this.sliderPidsMode||c&&!this.expertMode),e("#sliderIGain").prop("disabled",!this.sliderPidsMode||g&&!this.expertMode),e("#sliderRollPitchRatio").prop("disabled",!this.sliderPidsMode||n&&!this.expertMode),e("#sliderPitchPIGain").prop("disabled",!this.sliderPidsMode||R&&!this.expertMode),e("#sliderMasterMultiplier").prop("disabled",!this.sliderPidsMode||_&&!this.expertMode),e(".subtab-pid .expertSettingsDetectedNote").toggle(!this.sliderPidsMode||(p||E)&&!this.expertMode)};s.updateExpertModeFilterSlidersDisplay=function(){const r=(t.TUNING_SLIDERS.slider_gyro_filter_multiplier<this.NON_EXPERT_SLIDER_MIN_GYRO||t.TUNING_SLIDERS.slider_gyro_filter_multiplier>this.NON_EXPERT_SLIDER_MAX_GYRO)&&!this.expertMode,i=(t.TUNING_SLIDERS.slider_dterm_filter_multiplier<this.NON_EXPERT_SLIDER_MIN_DTERM||t.TUNING_SLIDERS.slider_dterm_filter_multiplier>this.NON_EXPERT_SLIDER_MAX_DTERM)&&!this.expertMode,o=e('.pid_filter input[name="gyroLowpassDynMinFrequency"]'),c=e('.pid_filter input[name="gyroLowpassFrequency"]'),g=e('.pid_filter input[name="gyroLowpass2Frequency"]'),n=e('.pid_filter input[name="dtermLowpassDynMinFrequency"]'),R=e('.pid_filter input[name="dtermLowpassFrequency"]'),_=e('.pid_filter input[name="dtermLowpass2Frequency"]'),p=parseInt(o.val())===0&&parseInt(c.val())===0&&parseInt(g.val())===0,E=parseInt(n.val())===0&&parseInt(R.val())===0&&parseInt(_.val())===0,A=!this.sliderGyroFilter||r||p,G=!this.sliderDTermFilter||i||E;e(".sliderGyroFilter").toggleClass("disabledSliders",A),e(".sliderDTermFilter").toggleClass("disabledSliders",G),e("#sliderGyroFilterMultiplier").prop("disabled",A),e("#sliderDTermFilterMultiplier").prop("disabled",G),e(".subtab-filter .expertSettingsDetectedNote").toggle(r||i)};s.setExpertMode=function(r){this.expertMode=r,this.updateExpertModePidSlidersDisplay(),this.updateExpertModeFilterSlidersDisplay(),e(".tab-pid_tuning .legacySlider").hide(),e(".legacyNonExpertModeSlidersNote").hide(),e(".subtab-pid .nonExpertModeSlidersNote").toggle(!this.pidSlidersUnavailable&&!this.expertMode),e(".subtab-filter .nonExpertModeSlidersNote").toggle((!this.GyroSliderUnavailable||!this.DTermSliderUnavailable)&&!this.expertMode)};s.scaleSliderValue=function(r){return r>1?Math.round(((r-1)*2+1)*10)/10:r};s.downscaleSliderValue=function(r){return r>1?(r-1)/2+1:r};s.initPidSlidersPosition=function(){this.sliderPidsMode=t.TUNING_SLIDERS.slider_pids_mode,this.sliderDGain=t.TUNING_SLIDERS.slider_d_gain/100,this.sliderPIGain=t.TUNING_SLIDERS.slider_pi_gain/100,this.sliderFeedforwardGain=t.TUNING_SLIDERS.slider_feedforward_gain/100,this.sliderDMaxGain=t.TUNING_SLIDERS.slider_dmax_gain/100,this.sliderIGain=t.TUNING_SLIDERS.slider_i_gain/100,this.sliderRollPitchRatio=t.TUNING_SLIDERS.slider_roll_pitch_ratio/100,this.sliderPitchPIGain=t.TUNING_SLIDERS.slider_pitch_pi_gain/100,this.sliderMasterMultiplier=t.TUNING_SLIDERS.slider_master_multiplier/100,e('output[name="sliderDGain-number"]').val(this.sliderDGain),e('output[name="sliderPIGain-number"]').val(this.sliderPIGain),e('output[name="sliderFeedforwardGain-number"]').val(this.sliderFeedforwardGain),e('output[name="sliderDMaxGain-number"]').val(this.sliderDMaxGain),e('output[name="sliderIGain-number"]').val(this.sliderIGain),e('output[name="sliderRollPitchRatio-number"]').val(this.sliderRollPitchRatio),e('output[name="sliderPitchPIGain-number"]').val(this.sliderPitchPIGain),e('output[name="sliderMasterMultiplier-number"]').val(this.sliderMasterMultiplier),e("#sliderDGain").val(this.sliderDGain),e("#sliderPIGain").val(this.sliderPIGain),e("#sliderFeedforwardGain").val(this.sliderFeedforwardGain),e("#sliderDMaxGain").val(this.sliderDMaxGain),e("#sliderIGain").val(this.sliderIGain),e("#sliderRollPitchRatio").val(this.sliderRollPitchRatio),e("#sliderPitchPIGain").val(this.sliderPitchPIGain),e("#sliderMasterMultiplier").val(this.sliderMasterMultiplier)};s.initGyroFilterSliderPosition=function(){this.sliderGyroFilter=t.TUNING_SLIDERS.slider_gyro_filter,this.sliderGyroFilterMultiplier=t.TUNING_SLIDERS.slider_gyro_filter_multiplier/100,e("#sliderGyroFilterMultiplier").val(this.sliderGyroFilterMultiplier),e('output[name="sliderGyroFilterMultiplier-number"]').val(this.sliderGyroFilterMultiplier)};s.initDTermFilterSliderPosition=function(){this.sliderDTermFilter=t.TUNING_SLIDERS.slider_dterm_filter,this.sliderDTermFilterMultiplier=t.TUNING_SLIDERS.slider_dterm_filter_multiplier/100,e("#sliderDTermFilterMultiplier").val(this.sliderDTermFilterMultiplier),e('output[name="sliderDTermFilterMultiplier-number"]').val(this.sliderDTermFilterMultiplier)};s.gyroFilterSliderEnable=function(){this.sliderGyroFilter=1,this.calculateNewGyroFilters()};s.dtermFilterSliderEnable=function(){this.sliderDTermFilter=1,this.calculateNewDTermFilters()};s.gyroFilterSliderDisable=function(){t.TUNING_SLIDERS.slider_gyro_filter=0,this.updateGyroFilterSliderDisplay()};s.dtermFilterSliderDisable=function(){t.TUNING_SLIDERS.slider_dterm_filter=0,this.updateDTermFilterSliderDisplay()};s.updateSlidersWarning=function(r=!1){const c=2.5*t.PIDS[0][0],g=42,n=P.lt(t.CONFIG.apiVersion,We)?t.PIDS[0][0]>70||t.PIDS[0][1]>c||t.PIDS[0][2]>60||t.ADVANCED_TUNING.dMaxRoll>g:t.PIDS[0][0]>70||t.PIDS[0][1]>c||t.PIDS[0][2]>g||t.ADVANCED_TUNING.dMaxRoll>60;e(".subtab-pid .slidersWarning").toggle(n&&!r)};s.updateFilterSlidersWarning=function(){e(".subtab-filter .slidersWarning").toggle(this.sliderGyroFilterMultiplier>=1.55||this.sliderGyroFilterMultiplier<=.45||this.sliderDTermFilterMultiplier>=1.25||this.sliderDTermFilterMultiplier<=.75)};s.updatePidSlidersDisplay=function(){e("#pid_main .ROLL .pid_data input, #pid_main .PITCH .pid_data input").each((r,i)=>e(i).prop("disabled",this.sliderPidsMode>0)),e("#pid_main .YAW .pid_data input").each((r,i)=>e(i).prop("disabled",this.sliderPidsMode===2)),this.updateExpertModePidSlidersDisplay(),e("#sliderPidsModeSelect").val(this.sliderPidsMode),this.updateSlidersWarning(this.pidSlidersUnavailable)};s.updateGyroFilterSliderDisplay=function(){const r=e('.pid_filter input[name="gyroLowpassDynMinFrequency"]'),i=e('.pid_filter input[name="gyroLowpassDynMaxFrequency"]'),o=e('.pid_filter input[name="gyroLowpassFrequency"]'),c=e('.pid_filter input[name="gyroLowpass2Frequency"]'),g=(t.TUNING_SLIDERS.slider_gyro_filter_multiplier<this.NON_EXPERT_SLIDER_MIN_GYRO||t.TUNING_SLIDERS.slider_gyro_filter_multiplier>this.NON_EXPERT_SLIDER_MAX_GYRO)&&!this.expertMode;t.TUNING_SLIDERS.slider_gyro_filter===0?(this.GyroSliderUnavailable=!0,this.sliderGyroFilter=0):(this.GyroSliderUnavailable=!1,this.sliderGyroFilter=1,this.cachedGyroSliderValues=!0),r.val(t.FILTER_CONFIG.gyro_lowpass_dyn_min_hz).prop("disabled",this.sliderGyroFilter),i.val(t.FILTER_CONFIG.gyro_lowpass_dyn_max_hz).prop("disabled",this.sliderGyroFilter),o.val(t.FILTER_CONFIG.gyro_lowpass_hz).prop("disabled",this.sliderGyroFilter),c.val(t.FILTER_CONFIG.gyro_lowpass2_hz).prop("disabled",this.sliderGyroFilter),e('output[name="sliderGyroFilterMultiplier-number"]').val(this.sliderGyroFilterMultiplier);const R=t.FILTER_CONFIG.gyro_lowpass_dyn_min_hz===0&&t.FILTER_CONFIG.gyro_lowpass_hz===0&&t.FILTER_CONFIG.gyro_lowpass2_hz===0||g||this.GyroSliderUnavailable;e('select[id="sliderGyroFilterModeSelect"]').val(this.sliderGyroFilter),e(".sliderGyroFilter").toggleClass("disabledSliders",R),e('input[id="sliderGyroFilterMultiplier"]').prop("disabled",R),this.updateFilterSlidersWarning()};s.updateDTermFilterSliderDisplay=function(){const r=e('.pid_filter input[name="dtermLowpassDynMinFrequency"]'),i=e('.pid_filter input[name="dtermLowpassDynMaxFrequency"]'),o=e('.pid_filter input[name="dtermLowpassFrequency"]'),c=e('.pid_filter input[name="dtermLowpass2Frequency"]'),g=(t.TUNING_SLIDERS.slider_dterm_filter_multiplier<this.NON_EXPERT_SLIDER_MIN_DTERM||t.TUNING_SLIDERS.slider_dterm_filter_multiplier>this.NON_EXPERT_SLIDER_MAX_DTERM)&&!this.expertMode;t.TUNING_SLIDERS.slider_dterm_filter===0?(this.DTermSliderUnavailable=!0,this.sliderDTermFilter=0):(this.DTermSliderUnavailable=!1,this.sliderDTermFilter=1,this.cachedDTermSliderValues=!0),r.val(t.FILTER_CONFIG.dterm_lowpass_dyn_min_hz).prop("disabled",this.sliderDTermFilter),i.val(t.FILTER_CONFIG.dterm_lowpass_dyn_max_hz).prop("disabled",this.sliderDTermFilter),o.val(t.FILTER_CONFIG.dterm_lowpass_hz).prop("disabled",this.sliderDTermFilter),c.val(t.FILTER_CONFIG.dterm_lowpass2_hz).prop("disabled",this.sliderDTermFilter);const R=t.FILTER_CONFIG.dterm_lowpass_dyn_min_hz===0&&t.FILTER_CONFIG.dterm_lowpass_hz===0&&t.FILTER_CONFIG.dterm_lowpass2_hz===0||g||this.DTermSliderUnavailable;e('output[name="sliderDTermFilterMultiplier-number"]').val(this.sliderDTermFilterMultiplier),e('select[id="sliderDTermFilterModeSelect"]').val(this.sliderDTermFilter),e(".sliderDTermFilter").toggleClass("disabledSliders",R),e('input[id="sliderDTermFilterMultiplier"]').prop("disabled",R),this.updateFilterSlidersWarning()};s.updateFilterSlidersDisplay=function(){this.updateGyroFilterSliderDisplay(),this.updateDTermFilterSliderDisplay(),e(".subtab-filter .nonExpertModeSlidersNote").toggle((!this.GyroSliderUnavailable||!this.DTermSliderUnavailable)&&!this.expertMode)};s.updateFormPids=function(r=!1){r||(t.PID_NAMES.forEach(function(i,o){e(`.pid_tuning .${i} input`).each(function(g){o<3&&g<3&&e(this).val(t.PIDS[o][g])})}),e('.pid_tuning input[name="dMaxRoll"]').val(t.ADVANCED_TUNING.dMaxRoll),e('.pid_tuning input[name="dMaxPitch"]').val(t.ADVANCED_TUNING.dMaxPitch),e('.pid_tuning input[name="dMaxYaw"]').val(t.ADVANCED_TUNING.dMaxYaw),e('.pid_tuning .ROLL input[name="f"]').val(t.ADVANCED_TUNING.feedforwardRoll),e('.pid_tuning .PITCH input[name="f"]').val(t.ADVANCED_TUNING.feedforwardPitch),e('.pid_tuning .YAW input[name="f"]').val(t.ADVANCED_TUNING.feedforwardYaw)),e('output[name="sliderDGain-number"]').val(this.sliderDGain),e('output[name="sliderPIGain-number"]').val(this.sliderPIGain),e('output[name="sliderFeedforwardGain-number"]').val(this.sliderFeedforwardGain),e('output[name="sliderDMaxGain-number"]').val(this.sliderDMaxGain),e('output[name="sliderIGain-number"]').val(this.sliderIGain),e('output[name="sliderRollPitchRatio-number"]').val(this.sliderRollPitchRatio),e('output[name="sliderPitchPIGain-number"]').val(this.sliderPitchPIGain),e('output[name="sliderMasterMultiplier-number"]').val(this.sliderMasterMultiplier),this.updateSlidersWarning()};s.calculateNewPids=function(r=!1){t.TUNING_SLIDERS.slider_pids_mode=this.sliderPidsMode,t.TUNING_SLIDERS.slider_d_gain=Math.round(this.sliderDGain*20)*5,t.TUNING_SLIDERS.slider_pi_gain=Math.round(this.sliderPIGain*20)*5,t.TUNING_SLIDERS.slider_feedforward_gain=Math.round(this.sliderFeedforwardGain*20)*5,t.TUNING_SLIDERS.slider_dmax_gain=Math.round(this.sliderDMaxGain*20)*5,t.TUNING_SLIDERS.slider_i_gain=Math.round(this.sliderIGain*20)*5,t.TUNING_SLIDERS.slider_roll_pitch_ratio=Math.round(this.sliderRollPitchRatio*20)*5,t.TUNING_SLIDERS.slider_pitch_pi_gain=Math.round(this.sliderPitchPIGain*20)*5,t.TUNING_SLIDERS.slider_master_multiplier=Math.round(this.sliderMasterMultiplier*20)*5,this.readSimplifiedPids()};s.calculateNewGyroFilters=function(){this.readSimplifiedGyroFilters()};s.calculateNewDTermFilters=function(){this.readSimplifiedDTermFilters()};s.readSimplifiedPids=function(r=!1){t.TUNING_SLIDERS.slider_pids_mode=this.sliderPidsMode,t.TUNING_SLIDERS.slider_master_multiplier=Math.round(this.sliderMasterMultiplier*100),t.TUNING_SLIDERS.slider_roll_pitch_ratio=Math.round(this.sliderRollPitchRatio*100),t.TUNING_SLIDERS.slider_i_gain=Math.round(this.sliderIGain*100),t.TUNING_SLIDERS.slider_d_gain=Math.round(this.sliderDGain*100),t.TUNING_SLIDERS.slider_pi_gain=Math.round(this.sliderPIGain*100),t.TUNING_SLIDERS.slider_dmax_gain=Math.round(this.sliderDMaxGain*100),t.TUNING_SLIDERS.slider_feedforward_gain=Math.round(this.sliderFeedforwardGain*100),t.TUNING_SLIDERS.slider_pitch_pi_gain=Math.round(this.sliderPitchPIGain*100),y.promise(h.MSP_CALCULATE_SIMPLIFIED_PID,K.crunch(h.MSP_CALCULATE_SIMPLIFIED_PID)).then(()=>this.updateFormPids(r))};s.readSimplifiedGyroFilters=function(){t.TUNING_SLIDERS.slider_gyro_filter=this.sliderGyroFilter,t.TUNING_SLIDERS.slider_gyro_filter_multiplier=this.sliderGyroFilterMultiplier*100,t.FILTER_CONFIG.gyro_lowpass_hz=parseInt(e('.pid_filter input[name="gyroLowpassFrequency"]').val()),t.FILTER_CONFIG.gyro_lowpass2_hz=parseInt(e('.pid_filter input[name="gyroLowpass2Frequency"]').val()),t.FILTER_CONFIG.gyro_lowpass_dyn_min_hz=parseInt(e('.pid_filter input[name="gyroLowpassDynMinFrequency"]').val()),y.promise(h.MSP_CALCULATE_SIMPLIFIED_GYRO,K.crunch(h.MSP_CALCULATE_SIMPLIFIED_GYRO)).then(()=>this.updateGyroFilterSliderDisplay())};s.readSimplifiedDTermFilters=function(){t.TUNING_SLIDERS.slider_dterm_filter=this.sliderDTermFilter,t.TUNING_SLIDERS.slider_dterm_filter_multiplier=this.sliderDTermFilterMultiplier*100,t.FILTER_CONFIG.dterm_lowpass_hz=parseInt(e('.pid_filter input[name="dtermLowpassFrequency"]').val()),t.FILTER_CONFIG.dterm_lowpass2_hz=parseInt(e('.pid_filter input[name="dtermLowpass2Frequency"]').val()),t.FILTER_CONFIG.dterm_lowpass_dyn_min_hz=parseInt(e('.pid_filter input[name="dtermLowpassDynMinFrequency"]').val()),y.promise(h.MSP_CALCULATE_SIMPLIFIED_DTERM,K.crunch(h.MSP_CALCULATE_SIMPLIFIED_DTERM)).then(()=>this.updateDTermFilterSliderDisplay())};s.validateTuningSliders=function(){y.promise(h.MSP_VALIDATE_SIMPLIFIED_TUNING).then(()=>{this.sliderPidsMode=t.TUNING_SLIDERS.slider_pids_valid>0?t.TUNING_SLIDERS.slider_pids_mode:0,this.sliderGyroFilter=t.TUNING_SLIDERS.slider_gyro_valid,this.sliderDTermFilter=t.TUNING_SLIDERS.slider_dterm_valid,t.TUNING_SLIDERS.slider_pids_mode=t.TUNING_SLIDERS.slider_pids_valid?t.TUNING_SLIDERS.slider_pids_mode:0,t.TUNING_SLIDERS.slider_gyro_filter=t.TUNING_SLIDERS.slider_gyro_valid?t.TUNING_SLIDERS.slider_gyro_filter:0,t.TUNING_SLIDERS.slider_dterm_filter=t.TUNING_SLIDERS.slider_dterm_valid?t.TUNING_SLIDERS.slider_dterm_filter:0,e("#sliderPidsModeSelect").val(this.sliderPidsMode),e("#sliderGyroFilterModeSelect").val(this.sliderGyroFilter),e("#sliderDTermFilterModeSelect").val(this.sliderDTermFilter),this.updatePidSlidersDisplay(),this.updateGyroFilterSliderDisplay(),this.updateDTermFilterSliderDisplay()})};const L={RATE_PROFILE_MASK:128,showAllPids:!1,updating:!0,dirty:!1,previousFilterDynQ:null,previousFilterDynCount:null,currentProfile:null,currentRateProfile:null,currentRatesType:null,previousRatesType:null,SETPOINT_WEIGHT_RANGE_LOW:2.55,SETPOINT_WEIGHT_RANGE_HIGH:20,SETPOINT_WEIGHT_RANGE_LEGACY:2.54,activeSubtab:"pid",analyticsChanges:{},CONFIGURATOR_PIDS:[],CONFIGURATOR_ADVANCED_TUNING:{},CONFIGURATOR_FILTER_CONFIG:{},CONFIGURATOR_RC_TUNING:{},CONFIGURATOR_FEATURE_CONFIG:{},CONFIGURATOR_TUNING_SLIDERS:{}};L.initialize=function(r){const i=this;Re.active_tab!=="pid_tuning"&&(Re.active_tab="pid_tuning",i.activeSubtab="pid");const o=t.getFilterDefaults();y.promise(h.MSP_PID_CONTROLLER).then(()=>y.promise(h.MSP_PIDNAMES)).then(()=>y.promise(h.MSP_PID)).then(()=>y.promise(h.MSP_PID_ADVANCED)).then(()=>y.promise(h.MSP_RC_TUNING)).then(()=>y.promise(h.MSP_FILTER_CONFIG)).then(()=>y.promise(h.MSP_RC_DEADBAND)).then(()=>y.promise(h.MSP_MOTOR_CONFIG)).then(()=>P.gte(t.CONFIG.apiVersion,z)?y.promise(h.MSP2_GET_TEXT,K.crunch(h.MSP2_GET_TEXT,h.PID_PROFILE_NAME)):!0).then(()=>P.gte(t.CONFIG.apiVersion,z)?y.promise(h.MSP2_GET_TEXT,K.crunch(h.MSP2_GET_TEXT,h.RATE_PROFILE_NAME)):!0).then(()=>y.promise(h.MSP_SIMPLIFIED_TUNING)).then(()=>y.promise(h.MSP_ADVANCED_CONFIG)).then(()=>y.send_message(h.MSP_MIXER_CONFIG,!1,!1,c));function c(){e("#content").load("./tabs/pid_tuning.html",pe)}const g=!1;function n(){i.setProfile(),i.setRateProfile(),P.gte(t.CONFIG.apiVersion,z)?(e('input[name="pidProfileName"]').val(t.CONFIG.pidProfileNames[t.CONFIG.profile]),e('input[name="rateProfileName"]').val(t.CONFIG.rateProfileNames[t.CONFIG.rateProfile])):e(".profile_name").hide(),t.PID_NAMES.forEach(function(l,u){e(`.pid_tuning .${l} input`).each(($,O)=>{t.PIDS[u][$]!==void 0&&e(O).val(t.PIDS_ACTIVE[u][$])})}),e('.pid_tuning input[name="rc_rate"]').val(t.RC_TUNING.RC_RATE.toFixed(2)),e('.pid_tuning input[name="roll_pitch_rate"]').val(t.RC_TUNING.roll_pitch_rate.toFixed(2)),e('.pid_tuning input[name="roll_rate"]').val(t.RC_TUNING.roll_rate.toFixed(2)),e('.pid_tuning input[name="pitch_rate"]').val(t.RC_TUNING.pitch_rate.toFixed(2)),e('.pid_tuning input[name="yaw_rate"]').val(t.RC_TUNING.yaw_rate.toFixed(2)),e('.pid_tuning input[name="rc_expo"]').val(t.RC_TUNING.RC_EXPO.toFixed(2)),e('.pid_tuning input[name="rc_yaw_expo"]').val(t.RC_TUNING.RC_YAW_EXPO.toFixed(2)),e('.throttle input[name="mid"]').val(t.RC_TUNING.throttle_MID.toFixed(2)),e('.throttle input[name="expo"]').val(t.RC_TUNING.throttle_EXPO.toFixed(2)),P.gte(t.CONFIG.apiVersion,z)?(e('select[id="tpaMode"]').val(t.ADVANCED_TUNING.tpaMode),e('input[id="tpaRate"]').val(t.ADVANCED_TUNING.tpaRate*100),e('input[id="tpaBreakpoint"]').val(t.ADVANCED_TUNING.tpaBreakpoint)):(e('.tpa-old input[name="tpa"]').val(t.RC_TUNING.dynamic_THR_PID.toFixed(2)),e('.tpa-old input[name="tpa-breakpoint"]').val(t.RC_TUNING.dynamic_THR_breakpoint)),e(".vbatpidcompensation").toggle(g),e('input[id="vbatpidcompensation"]').prop("checked",t.ADVANCED_TUNING.vbatPidCompensation!==0),e("#pid-tuning .delta select").val(t.ADVANCED_TUNING.deltaMethod),e('.pid_tuning input[name="rc_rate_yaw"]').val(t.RC_TUNING.rcYawRate.toFixed(2)),e('.pid_filter input[name="gyroLowpassFrequency"]').val(t.FILTER_CONFIG.gyro_lowpass_hz),e('.pid_filter input[name="dtermLowpassFrequency"]').val(t.FILTER_CONFIG.dterm_lowpass_hz),e('.pid_filter input[name="yawLowpassFrequency"]').val(t.FILTER_CONFIG.yaw_lowpass_hz),e("#pid-tuning .rate").text(F.getMessage("pidTuningSuperRate")),e('.pid_filter input[name="gyroNotch1Frequency"]').val(t.FILTER_CONFIG.gyro_notch_hz),e('.pid_filter input[name="gyroNotch1Cutoff"]').val(t.FILTER_CONFIG.gyro_notch_cutoff),e('.pid_filter input[name="dTermNotchFrequency"]').val(t.FILTER_CONFIG.dterm_notch_hz),e('.pid_filter input[name="dTermNotchCutoff"]').val(t.FILTER_CONFIG.dterm_notch_cutoff),e('input[name="dtermSetpointTransition-number"]').val(t.ADVANCED_TUNING.dtermSetpointTransition/100),e('input[name="dtermSetpoint-number"]').val(t.ADVANCED_TUNING.dtermSetpointWeight/100),e('.pid_filter input[name="gyroNotch2Frequency"]').val(t.FILTER_CONFIG.gyro_notch2_hz),e('.pid_filter input[name="gyroNotch2Cutoff"]').val(t.FILTER_CONFIG.gyro_notch2_cutoff),e('.pid_tuning input[name="angleLimit"]').val(t.ADVANCED_TUNING.levelAngleLimit),e('.pid_tuning input[name="sensitivity"]').hide(),e(".pid_tuning .levelSensitivityHeader").empty();const m=e("#antiGravitySwitch"),N=e('.antigravity input[name="itermAcceleratorGain"]');e('.pid_filter select[name="dtermLowpassType"]').val(t.FILTER_CONFIG.dterm_lowpass_type);const I=0;P.gte(t.CONFIG.apiVersion,z)?(N.val(t.ADVANCED_TUNING.antiGravityGain/10),m.prop("checked",t.ADVANCED_TUNING.antiGravityGain!==I)):(e('.antigravity input[name="itermThrottleThreshold"]').val(t.ADVANCED_TUNING.itermThrottleThreshold),N.val(t.ADVANCED_TUNING.itermAcceleratorGain/1e3),m.prop("checked",t.ADVANCED_TUNING.itermAcceleratorGain!==I)),P.gte(t.CONFIG.apiVersion,z)&&N.attr({min:"0.1",max:"25.0",step:"0.1"}),m.on("change",function(){if(m.is(":checked")){if(P.gte(t.CONFIG.apiVersion,z))N.val(Number.parseFloat(t.ADVANCED_TUNING.antiGravityGain/10||8).toFixed(1));else if(t.ADVANCED_TUNING.itermAcceleratorGain===I)N.val(3.5);else{const u=t.ADVANCED_TUNING.itermAcceleratorGain/1e3;N.val(u)}e(".antigravity .suboption").show(),e(".antigravity .antiGravityThres").toggle(P.lt(t.CONFIG.apiVersion,z)&&t.ADVANCED_TUNING.itermAcceleratorGain===0),e(".antigravity .antiGravityMode").toggle(P.lt(t.CONFIG.apiVersion,z))}else P.gte(t.CONFIG.apiVersion,z)?N.val(I/1e3):(e('.antigravity select[id="antiGravityMode"]').val(0),N.val(I)),e(".antigravity .suboption").hide()}),m.trigger("change"),e('.pid_tuning input[name="rc_rate_pitch"]').val(t.RC_TUNING.rcPitchRate.toFixed(2)),e('.pid_tuning input[name="rc_pitch_expo"]').val(t.RC_TUNING.RC_PITCH_EXPO.toFixed(2)),e('.pid_filter input[name="gyroLowpass2Frequency"]').val(t.FILTER_CONFIG.gyro_lowpass2_hz),e('.pid_filter select[name="gyroLowpassType"]').val(t.FILTER_CONFIG.gyro_lowpass_type),e('.pid_filter select[name="gyroLowpass2Type"]').val(t.FILTER_CONFIG.gyro_lowpass2_type),e('.pid_filter input[name="dtermLowpass2Frequency"]').val(t.FILTER_CONFIG.dterm_lowpass2_hz),e('.pid_filter select[name="dtermLowpass2Type"]').val(t.FILTER_CONFIG.dterm_lowpass2_type),e('input[id="itermrotation"]').prop("checked",t.ADVANCED_TUNING.itermRotation!==0),e('input[id="smartfeedforward"]').prop("checked",t.ADVANCED_TUNING.smartFeedforward!==0);const C=e('input[id="itermrelax"]');if(C.prop("checked",t.ADVANCED_TUNING.itermRelax!==0),e('select[id="itermrelaxAxes"]').val(t.ADVANCED_TUNING.itermRelax>0?t.ADVANCED_TUNING.itermRelax:1),e('select[id="itermrelaxType"]').val(t.ADVANCED_TUNING.itermRelaxType),e('input[name="itermRelaxCutoff"]').val(t.ADVANCED_TUNING.itermRelaxCutoff),C.change(function(){e(this).is(":checked")?(e(".itermrelax .suboption").show(),e(".itermRelaxCutoff").show()):e(".itermrelax .suboption").hide()}),C.change(),e('input[name="absoluteControlGain-number"]').val(t.ADVANCED_TUNING.absoluteControlGain).trigger("input"),e('input[name="throttleBoost-number"]').val(t.ADVANCED_TUNING.throttleBoost).trigger("input"),e('input[name="acroTrainerAngleLimit-number"]').val(t.ADVANCED_TUNING.acroTrainerAngleLimit).trigger("input"),e('.pid_tuning .YAW input[name="d"]').val(t.PIDS[2][2]),e('.pid_tuning .ROLL input[name="f"]').val(t.ADVANCED_TUNING.feedforwardRoll),e('.pid_tuning .PITCH input[name="f"]').val(t.ADVANCED_TUNING.feedforwardPitch),e('.pid_tuning .YAW input[name="f"]').val(t.ADVANCED_TUNING.feedforwardYaw),e('input[name="feedforwardTransition-number"]').val(Number.parseFloat(t.ADVANCED_TUNING.feedforwardTransition/100).toFixed(2)),P.lt(t.CONFIG.apiVersion,z)){const l=e('.antigravity select[id="antiGravityMode"]');l.on("change",function(){const u=l.val();e(".antiGravityThres").toggle(u!==0)}),l.val(t.ADVANCED_TUNING.antiGravityMode).trigger("change")}e('select[id="throttleLimitType"]').val(t.RC_TUNING.throttleLimitType),e('.throttle_limit input[name="throttleLimitPercent"]').val(t.RC_TUNING.throttleLimitPercent),e('.pid_filter input[name="gyroLowpassDynMinFrequency"]').val(t.FILTER_CONFIG.gyro_lowpass_dyn_min_hz),e('.pid_filter input[name="gyroLowpassDynMaxFrequency"]').val(t.FILTER_CONFIG.gyro_lowpass_dyn_max_hz),e('.pid_filter select[name="gyroLowpassDynType"]').val(t.FILTER_CONFIG.gyro_lowpass_type),e('.pid_filter input[name="dtermLowpassDynMinFrequency"]').val(t.FILTER_CONFIG.dterm_lowpass_dyn_min_hz),e('.pid_filter input[name="dtermLowpassDynMaxFrequency"]').val(t.FILTER_CONFIG.dterm_lowpass_dyn_max_hz),e('.pid_filter select[name="dtermLowpassDynType"]').val(t.FILTER_CONFIG.dterm_lowpass_type),e('.pid_tuning input[name="dMaxRoll"]').val(t.ADVANCED_TUNING.dMaxRoll),e('.pid_tuning input[name="dMaxPitch"]').val(t.ADVANCED_TUNING.dMaxPitch),e('.pid_tuning input[name="dMaxYaw"]').val(t.ADVANCED_TUNING.dMaxYaw),e('.dMaxGroup input[name="dMaxGain"]').val(t.ADVANCED_TUNING.dMaxGain),e('.dMaxGroup input[name="dMaxAdvance"]').val(t.ADVANCED_TUNING.dMaxAdvance),e('input[id="useIntegratedYaw"]').prop("checked",t.ADVANCED_TUNING.useIntegratedYaw!==0),e(".smartfeedforward").hide();const V=t.CONFIG.sampleRateHz/t.PID_ADVANCED_CONFIG.pid_process_denom;let v=t.FEATURE_CONFIG.features.isEnabled("DYNAMIC_FILTER");v=v||t.FILTER_CONFIG.dyn_notch_count!==0,v=v&&V>=2e3;const j=e('.pid_filter select[name="dynamicNotchRange"]'),B=e('.pid_filter input[name="dynamicNotchWidthPercent"]'),b=e('.pid_filter input[name="dynamicNotchCount"]'),Q=e('.pid_filter input[name="dynamicNotchQ"]'),oe=e('.pid_filter input[name="dynamicNotchMinHz"]'),ee=e('.pid_filter input[name="dynamicNotchMaxHz"]');j.val(t.FILTER_CONFIG.dyn_notch_range),B.val(t.FILTER_CONFIG.dyn_notch_width_percent),b.val(t.FILTER_CONFIG.dyn_notch_count),Q.val(t.FILTER_CONFIG.dyn_notch_q),oe.val(t.FILTER_CONFIG.dyn_notch_min_hz),ee.val(t.FILTER_CONFIG.dyn_notch_max_hz),e('.pid_filter input[id="dynamicNotchEnabled"]').on("change",function(){const l=parseInt(b.val()),u=e(this).is(":checked");u&&!l&&b.val(o.dyn_notch_count),e(".dynamicNotch span.suboption").toggle(u),e(".dynamicNotchMaxHz").toggle(u),e(".dynamicNotchCount").toggle(u)}).prop("checked",v).trigger("change"),e(".rpmFilter").toggle(t.MOTOR_CONFIG.use_dshot_telemetry);const J=e('.pid_filter input[name="rpmFilterHarmonics"]'),M=e('.pid_filter input[name="rpmFilterMinHz"]');J.val(t.FILTER_CONFIG.gyro_rpm_notch_harmonics),M.val(t.FILTER_CONFIG.gyro_rpm_notch_min_hz),e(".pid_filter #rpmFilterEnabled").on("change",function(){const l=J.val(),u=e(this).is(":checked")&&l!==0;J.attr("disabled",!u),M.attr("disabled",!u),i.previousFilterDynQ=t.FILTER_CONFIG.dyn_notch_q,i.previousFilterDynCount=t.FILTER_CONFIG.dyn_notch_count,l==0&&J.val(o.gyro_rpm_notch_harmonics);const f={title:F.getMessage("dialogDynFiltersChangeTitle"),text:F.getMessage("dialogDynFiltersChangeNote"),buttonYesText:F.getMessage("presetsWarningDialogYesButton"),buttonNoText:F.getMessage("presetsWarningDialogNoButton"),buttonYesCallback:()=>$(),buttonNoCallback:null},$=function(){u?(b.val(o.dyn_notch_count_rpm),Q.val(o.dyn_notch_q_rpm)):(b.val(o.dyn_notch_count),Q.val(o.dyn_notch_q))};u!==(t.FILTER_CONFIG.gyro_rpm_notch_harmonics!==0)?Re.showYesNoDialog(f):(b.val(i.previousFilterDynCount),Q.val(i.previousFilterDynQ)),e(".rpmFilter span.suboption").toggle(u)}).prop("checked",t.FILTER_CONFIG.gyro_rpm_notch_harmonics!==0).trigger("change"),P.gte(t.CONFIG.apiVersion,z)&&e('input[name="idleMinRpm-number"]').attr("max",200),e('.tab-pid_tuning input[name="motorLimit"]').val(t.ADVANCED_TUNING.motorOutputLimit),e('.tab-pid_tuning select[name="cellCount"]').val(t.ADVANCED_TUNING.autoProfileCellCount),e('input[name="idleMinRpm-number"]').val(t.ADVANCED_TUNING.idleMinRpm).prop("disabled",!t.MOTOR_CONFIG.use_dshot_telemetry),t.MOTOR_CONFIG.use_dshot_telemetry?e("span.pidTuningIdleMinRpmDisabled").text(F.getMessage("pidTuningIdleMinRpm")):e("span.pidTuningIdleMinRpmDisabled").text(F.getMessage("pidTuningIdleMinRpmDisabled"));const q=e('select[id="ratesType"]'),H=[{name:"Betaflight"},{name:"Raceflight"},{name:"KISS"},{name:"Actual"},{name:"QuickRates"}];for(let l=0;l<H.length;l++)q.append(`<option value="${l}">${H[l].name}</option>`);q.sortSelect(),i.currentRatesType=t.RC_TUNING.rates_type,i.previousRatesType=null,q.val(i.currentRatesType),i.changeRatesType(i.currentRatesType),e('.pid_filter input[name="dtermLowpassExpo"]').val(t.FILTER_CONFIG.dyn_lpf_curve_expo),e('select[id="feedforwardAveraging"]').val(t.ADVANCED_TUNING.feedforward_averaging),e('input[name="feedforwardSmoothFactor"]').val(t.ADVANCED_TUNING.feedforward_smooth_factor),e('input[name="feedforwardBoost"]').val(t.ADVANCED_TUNING.feedforward_boost),e('input[name="feedforwardMaxRateLimit"]').val(t.ADVANCED_TUNING.feedforward_max_rate_limit),e('input[name="feedforwardJitterFactor"]').val(t.ADVANCED_TUNING.feedforward_jitter_factor);const de=t.BATTERY_CONFIG.voltageMeterSource!==1,le=e('input[id="vbatSagCompensation"]').attr("disabled",de).change();le.prop("checked",t.ADVANCED_TUNING.vbat_sag_compensation!==0),e('input[name="vbatSagValue"]').val(t.ADVANCED_TUNING.vbat_sag_compensation>0?t.ADVANCED_TUNING.vbat_sag_compensation:100),le.change(function(){const l=e(this).is(":checked");e(".vbatSagCompensation .suboption").toggle(l)}).change();const ae=e('input[id="thrustLinearization"]');ae.prop("checked",t.ADVANCED_TUNING.thrustLinearization!==0),e('input[name="thrustLinearValue"]').val(t.ADVANCED_TUNING.thrustLinearization>0?t.ADVANCED_TUNING.thrustLinearization:20),ae.change(function(){const l=e(this).is(":checked");e(".thrustLinearization .suboption").toggle(l)}).change(),e('input[id="useIntegratedYaw"]').change(function(){const l=e(this).is(":checked");e("#pidTuningIntegratedYawCaution").toggle(l)}).change();function ce(l,u){const f=parseInt(l.val()),$=parseInt(u.val()),O=Math.min(Math.max(f,0),250),te=Math.min(Math.max($,0),250);$>O&&u.val(O),f<te&&l.val(te)}function Ee(l){const u=e(`.pid_tuning input[name="dMax${l}"]`),f=e(`.pid_tuning .${l} input[name="d"]`);u.change(function(){ce(f,u)}).change(),f.change(function(){ce(f,u)}).change()}["Roll","Pitch","Yaw"].forEach(l=>Ee(l)),e('input[id="gyroNotch1Enabled"]').change(function(){const l=e(this).is(":checked"),u=t.FILTER_CONFIG.gyro_notch_hz>0?t.FILTER_CONFIG.gyro_notch_hz:o.gyro_notch_hz;e('.pid_filter input[name="gyroNotch1Frequency"]').val(l?u:0).attr("disabled",!l).attr("min",l?1:0).change(),e('.pid_filter input[name="gyroNotch1Cutoff"]').attr("disabled",!l).change(),e(".gyroNotch1 span.suboption").toggle(l)}),e('input[id="gyroNotch2Enabled"]').change(function(){const l=e(this).is(":checked"),u=t.FILTER_CONFIG.gyro_notch2_hz>0?t.FILTER_CONFIG.gyro_notch2_hz:o.gyro_notch2_hz;e('.pid_filter input[name="gyroNotch2Frequency"]').val(l?u:0).attr("disabled",!l).attr("min",l?1:0).change(),e('.pid_filter input[name="gyroNotch2Cutoff"]').attr("disabled",!l).change(),e(".gyroNotch2 span.suboption").toggle(l)}),e('input[id="dtermNotchEnabled"]').change(function(){const l=e(this).is(":checked"),u=t.FILTER_CONFIG.dterm_notch_hz>0?t.FILTER_CONFIG.dterm_notch_hz:o.dterm_notch_hz;e('.pid_filter input[name="dTermNotchFrequency"]').val(l?u:0).attr("disabled",!l).attr("min",l?1:0).change(),e('.pid_filter input[name="dTermNotchCutoff"]').attr("disabled",!l).change(),e(".dtermNotch span.suboption").toggle(l)});const he=e('.pid_filter input[name="gyroLowpassDynMinFrequency"]'),Ne=e('.pid_filter input[name="gyroLowpassDynMaxFrequency"]'),Ie=e('.pid_filter input[name="gyroLowpassFrequency"]'),Fe=e('.pid_filter input[name="gyroLowpass2Frequency"]'),Ge=e('.pid_filter input[id="gyroLowpassEnabled"]'),De=e('.pid_filter input[id="gyroLowpass2Enabled"]'),be=e(".gyroLowpass span.suboption"),Le=e(".gyroLowpass span.suboption.static"),Z=e(".gyroLowpass span.suboption.dynamic"),ue=e(".gyroLowpass2 span.suboption"),ye=e('.pid_filter select[name="gyroLowpassFilterMode"]'),a=e('.pid_filter input[name="dtermLowpassDynMinFrequency"]'),d=e('.pid_filter input[name="dtermLowpassDynMaxFrequency"]'),T=e('.pid_filter input[name="dtermLowpassFrequency"]'),U=e('.pid_filter input[name="dtermLowpass2Frequency"]'),me=e('input[id="dtermLowpassEnabled"]'),Ce=e('input[id="dtermLowpass2Enabled"]'),Oe=e(".dtermLowpass span.suboption"),ze=e(".dtermLowpass span.suboption.static"),ke=e(".dtermLowpass span.suboption.dynamic"),se=e(".dtermLowpass2 span.suboption"),ge=e('.pid_filter select[name="dtermLowpassFilterMode"]');Ge.change(function(){const l=e(this).is(":checked");l?t.FILTER_CONFIG.gyro_lowpass_dyn_min_hz>0||t.FILTER_CONFIG.gyro_lowpass_hz>0?ye.val(t.FILTER_CONFIG.gyro_lowpass_dyn_min_hz>0?1:0).change():ye.val(1).change():(he.val(0),Ne.val(0),Ie.val(0),i.calculateNewGyroFilters()),be.toggle(l),Le.toggle(l&&t.FILTER_CONFIG.gyro_lowpass_dyn_min_hz===0),Z.toggle(l&&t.FILTER_CONFIG.gyro_lowpass_dyn_min_hz!==0)}),ye.change(function(){const l=parseInt(e(this).val()),u=t.FILTER_CONFIG.gyro_lowpass_hz>0?t.FILTER_CONFIG.gyro_lowpass_hz:o.gyro_lowpass_hz,f=t.FILTER_CONFIG.gyro_lowpass_dyn_min_hz>0?t.FILTER_CONFIG.gyro_lowpass_dyn_min_hz:o.gyro_lowpass_dyn_min_hz,$=t.FILTER_CONFIG.gyro_lowpass_dyn_max_hz>0?t.FILTER_CONFIG.gyro_lowpass_dyn_max_hz:o.gyro_lowpass_dyn_max_hz;Ie.val(l?0:u),he.val(l?f:0),Ne.val(l?$:0),i.calculateNewGyroFilters(),Le.toggle(!l),Z.toggle(!!l)}),De.change(function(){const l=e(this).is(":checked"),u=t.FILTER_CONFIG.gyro_lowpass2_hz>0?t.FILTER_CONFIG.gyro_lowpass2_hz:o.gyro_lowpass2_hz;Fe.val(l?u:0).attr("disabled",!l),i.calculateNewGyroFilters(),ue.toggle(l),i.updateFilterWarning()}),me.change(function(){const l=e(this).is(":checked");l?t.FILTER_CONFIG.dterm_lowpass_dyn_min_hz>0||t.FILTER_CONFIG.dterm_lowpass_hz>0?ge.val(t.FILTER_CONFIG.dterm_lowpass_dyn_min_hz>0?1:0).change():ge.val(1).change():(a.val(0),d.val(0),T.val(0),i.calculateNewDTermFilters()),Oe.toggle(l),ze.toggle(l&&t.FILTER_CONFIG.dterm_lowpass_dyn_min_hz===0),ke.toggle(l&&t.FILTER_CONFIG.dterm_lowpass_dyn_min_hz!==0)}),ge.change(function(){const l=parseInt(e(this).val()),u=t.FILTER_CONFIG.dterm_lowpass_hz>0?t.FILTER_CONFIG.dterm_lowpass_hz:o.dterm_lowpass_hz,f=t.FILTER_CONFIG.dterm_lowpass_dyn_min_hz>0?t.FILTER_CONFIG.dterm_lowpass_dyn_min_hz:o.dterm_lowpass_dyn_min_hz,$=t.FILTER_CONFIG.dterm_lowpass_dyn_max_hz>0?t.FILTER_CONFIG.dterm_lowpass_dyn_max_hz:o.dterm_lowpass_dyn_max_hz;T.val(l?0:u),a.val(l?f:0),d.val(l?$:0),i.calculateNewDTermFilters(),ze.toggle(!l),ke.toggle(!!l)}),Ce.change(function(){const l=e(this).is(":checked"),u=t.FILTER_CONFIG.dterm_lowpass2_hz>0?t.FILTER_CONFIG.dterm_lowpass2_hz:o.dterm_lowpass2_hz;U.val(l?u:0).attr("disabled",!l),i.calculateNewDTermFilters(),se.toggle(l),i.updateFilterWarning()}),e('input[id="yawLowpassEnabled"]').change(function(){const l=e(this).is(":checked"),u=t.FILTER_CONFIG.yaw_lowpass_hz>0?t.FILTER_CONFIG.yaw_lowpass_hz:o.yaw_lowpass_hz;e('.pid_filter input[name="yawLowpassFrequency"]').val(l?u:0).attr("disabled",!l),e(".yawLowpass span.suboption").toggle(l)});function fe(l,u){const f=parseInt(e(`.pid_filter input[name='${l}']`).val()),$=parseInt(e(`.pid_filter input[name='${u}']`).val()),O=f==0?0:f-1;e(`.pid_filter input[name='${u}']`).attr("max",O),$>=f&&e(`.pid_filter input[name='${u}']`).val(O)}e('input[name="gyroNotch1Frequency"]').change(function(){fe("gyroNotch1Frequency","gyroNotch1Cutoff")}).change(),e('input[name="gyroNotch2Frequency"]').change(function(){fe("gyroNotch2Frequency","gyroNotch2Cutoff")}).change(),e('input[name="dTermNotchFrequency"]').change(function(){fe("dTermNotchFrequency","dTermNotchCutoff")}).change(),e('input[id="gyroNotch1Enabled"]').prop("checked",t.FILTER_CONFIG.gyro_notch_hz!==0).change(),e('input[id="gyroNotch2Enabled"]').prop("checked",t.FILTER_CONFIG.gyro_notch2_hz!==0).change(),e('input[id="dtermNotchEnabled"]').prop("checked",t.FILTER_CONFIG.dterm_notch_hz!==0).change(),Ge.prop("checked",t.FILTER_CONFIG.gyro_lowpass_hz!==0||t.FILTER_CONFIG.gyro_lowpass_dyn_min_hz!==0).change(),me.prop("checked",t.FILTER_CONFIG.dterm_lowpass_hz!==0||t.FILTER_CONFIG.dterm_lowpass_dyn_min_hz!==0).change(),De.prop("checked",t.FILTER_CONFIG.gyro_lowpass2_hz!==0).change(),Ce.prop("checked",t.FILTER_CONFIG.dterm_lowpass2_hz!==0).change(),e('input[id="yawLowpassEnabled"]').prop("checked",t.FILTER_CONFIG.yaw_lowpass_hz!==0).change(),i.updatePIDColors()}function R(){P.gte(t.CONFIG.apiVersion,"1.45.0")&&(t.CONFIG.pidProfileNames[t.CONFIG.profile]=e('input[name="pidProfileName"]').val().trim(),t.CONFIG.rateProfileNames[t.CONFIG.rateProfile]=e('input[name="rateProfileName"]').val().trim()),t.PID_NAMES.forEach(function(oe,ee){e(`.pid_tuning .${oe} input`).each(function(M){e(this).val()&&(t.PIDS[ee][M]=parseInt(e(this).val()))})});const m=e('.pid_tuning input[name="pitch_rate"]'),N=e('.pid_tuning input[name="roll_rate"]'),I=e('.pid_tuning input[name="yaw_rate"]'),C=e('.pid_tuning input[name="rc_rate_pitch"]'),w=e('.pid_tuning input[name="rc_rate"]'),D=e('.pid_tuning input[name="rc_rate_yaw"]'),x=e('.pid_tuning input[name="rc_pitch_expo"]'),S=e('.pid_tuning input[name="rc_expo"]'),V=e('.pid_tuning input[name="rc_yaw_expo"]');switch(t.RC_TUNING.roll_pitch_rate=parseFloat(e('.pid_tuning input[name="roll_pitch_rate"]').val()),t.RC_TUNING.RC_RATE=parseFloat(w.val()),t.RC_TUNING.roll_rate=parseFloat(N.val()),t.RC_TUNING.pitch_rate=parseFloat(m.val()),t.RC_TUNING.yaw_rate=parseFloat(I.val()),t.RC_TUNING.RC_EXPO=parseFloat(S.val()),t.RC_TUNING.RC_YAW_EXPO=parseFloat(V.val()),t.RC_TUNING.rcYawRate=parseFloat(D.val()),t.RC_TUNING.rcPitchRate=parseFloat(C.val()),t.RC_TUNING.RC_PITCH_EXPO=parseFloat(x.val()),i.currentRatesType){case t.RATES_TYPE.RACEFLIGHT:t.RC_TUNING.pitch_rate=parseFloat(m.val())/100,t.RC_TUNING.roll_rate=parseFloat(N.val())/100,t.RC_TUNING.yaw_rate=parseFloat(I.val())/100,t.RC_TUNING.rcPitchRate=parseFloat(C.val())/1e3,t.RC_TUNING.RC_RATE=parseFloat(w.val())/1e3,t.RC_TUNING.rcYawRate=parseFloat(D.val())/1e3,t.RC_TUNING.RC_PITCH_EXPO=parseFloat(x.val())/100,t.RC_TUNING.RC_EXPO=parseFloat(S.val())/100,t.RC_TUNING.RC_YAW_EXPO=parseFloat(V.val())/100;break;case t.RATES_TYPE.ACTUAL:t.RC_TUNING.pitch_rate=parseFloat(m.val())/1e3,t.RC_TUNING.roll_rate=parseFloat(N.val())/1e3,t.RC_TUNING.yaw_rate=parseFloat(I.val())/1e3,t.RC_TUNING.rcPitchRate=parseFloat(C.val())/1e3,t.RC_TUNING.RC_RATE=parseFloat(w.val())/1e3,t.RC_TUNING.rcYawRate=parseFloat(D.val())/1e3;break;case t.RATES_TYPE.QUICKRATES:t.RC_TUNING.pitch_rate=parseFloat(m.val())/1e3,t.RC_TUNING.roll_rate=parseFloat(N.val())/1e3,t.RC_TUNING.yaw_rate=parseFloat(I.val())/1e3;break}t.RC_TUNING.throttle_MID=parseFloat(e('.throttle input[name="mid"]').val()),t.RC_TUNING.throttle_EXPO=parseFloat(e('.throttle input[name="expo"]').val()),P.gte(t.CONFIG.apiVersion,z)?(t.ADVANCED_TUNING.tpaMode=e('select[id="tpaMode"]').val(),t.ADVANCED_TUNING.tpaRate=parseInt(e('input[id="tpaRate"]').val())/100,t.ADVANCED_TUNING.tpaBreakpoint=parseInt(e('input[id="tpaBreakpoint"]').val())):(t.RC_TUNING.dynamic_THR_PID=parseFloat(e('.tpa-old input[name="tpa"]').val()),t.RC_TUNING.dynamic_THR_breakpoint=parseInt(e('.tpa-old input[name="tpa-breakpoint"]').val())),t.FILTER_CONFIG.gyro_lowpass_hz=parseInt(e('.pid_filter input[name="gyroLowpassFrequency"]').val()),t.FILTER_CONFIG.dterm_lowpass_hz=parseInt(e('.pid_filter input[name="dtermLowpassFrequency"]').val()),t.FILTER_CONFIG.yaw_lowpass_hz=parseInt(e('.pid_filter input[name="yawLowpassFrequency"]').val()),t.ADVANCED_TUNING.deltaMethod=e("#pid-tuning .delta select").val(),t.ADVANCED_TUNING.dtermSetpointTransition=parseInt(e('input[name="dtermSetpointTransition-number"]').val()*100),t.ADVANCED_TUNING.dtermSetpointWeight=parseInt(e('input[name="dtermSetpoint-number"]').val()*100),t.FILTER_CONFIG.gyro_notch_hz=parseInt(e('.pid_filter input[name="gyroNotch1Frequency"]').val()),t.FILTER_CONFIG.gyro_notch_cutoff=parseInt(e('.pid_filter input[name="gyroNotch1Cutoff"]').val()),t.FILTER_CONFIG.dterm_notch_hz=parseInt(e('.pid_filter input[name="dTermNotchFrequency"]').val()),t.FILTER_CONFIG.dterm_notch_cutoff=parseInt(e('.pid_filter input[name="dTermNotchCutoff"]').val()),t.FILTER_CONFIG.gyro_notch2_hz=parseInt(e('.pid_filter input[name="gyroNotch2Frequency"]').val()),t.FILTER_CONFIG.gyro_notch2_cutoff=parseInt(e('.pid_filter input[name="gyroNotch2Cutoff"]').val()),t.ADVANCED_TUNING.levelAngleLimit=parseInt(e('.pid_tuning input[name="angleLimit"]').val());const v=e('.antigravity input[name="itermAcceleratorGain"]');t.FILTER_CONFIG.dterm_lowpass_type=parseInt(e('.pid_filter select[name="dtermLowpassType"]').val()),P.gte(t.CONFIG.apiVersion,z)?t.ADVANCED_TUNING.antiGravityGain=parseInt(v.val()*10):(t.ADVANCED_TUNING.itermThrottleThreshold=parseInt(e('.antigravity input[name="itermThrottleThreshold"]').val()),t.ADVANCED_TUNING.itermAcceleratorGain=parseInt(v.val()*1e3)),t.FILTER_CONFIG.gyro_lowpass2_hz=parseInt(e('.pid_filter input[name="gyroLowpass2Frequency"]').val()),t.FILTER_CONFIG.gyro_lowpass_type=parseInt(e('.pid_filter select[name="gyroLowpassType"]').val()),t.FILTER_CONFIG.gyro_lowpass2_type=parseInt(e('.pid_filter select[name="gyroLowpass2Type"]').val()),t.FILTER_CONFIG.dterm_lowpass2_hz=parseInt(e('.pid_filter input[name="dtermLowpass2Frequency"]').val()),t.FILTER_CONFIG.dterm_lowpass2_type=parseInt(e('.pid_filter select[name="dtermLowpass2Type"]').val()),t.ADVANCED_TUNING.itermRotation=e('input[id="itermrotation"]').is(":checked")?1:0,t.ADVANCED_TUNING.smartFeedforward=e('input[id="smartfeedforward"]').is(":checked")?1:0,t.ADVANCED_TUNING.itermRelax=e('input[id="itermrelax"]').is(":checked")?e('select[id="itermrelaxAxes"]').val():0,t.ADVANCED_TUNING.itermRelaxType=e('select[id="itermrelaxType"]').val(),t.ADVANCED_TUNING.itermRelaxCutoff=parseInt(e('input[name="itermRelaxCutoff"]').val()),t.ADVANCED_TUNING.absoluteControlGain=e('input[name="absoluteControlGain-number"]').val(),t.ADVANCED_TUNING.throttleBoost=e('input[name="throttleBoost-number"]').val(),t.ADVANCED_TUNING.acroTrainerAngleLimit=e('input[name="acroTrainerAngleLimit-number"]').val(),t.ADVANCED_TUNING.feedforwardRoll=parseInt(e('.pid_tuning .ROLL input[name="f"]').val()),t.ADVANCED_TUNING.feedforwardPitch=parseInt(e('.pid_tuning .PITCH input[name="f"]').val()),t.ADVANCED_TUNING.feedforwardYaw=parseInt(e('.pid_tuning .YAW input[name="f"]').val()),t.ADVANCED_TUNING.feedforwardTransition=parseInt(e('input[name="feedforwardTransition-number"]').val()*100),t.ADVANCED_TUNING.antiGravityMode=P.lt(t.CONFIG.apiVersion,z)?e('select[id="antiGravityMode"]').val():0,t.RC_TUNING.throttleLimitType=e('select[id="throttleLimitType"]').val(),t.RC_TUNING.throttleLimitPercent=parseInt(e('.throttle_limit input[name="throttleLimitPercent"]').val()),t.FILTER_CONFIG.gyro_lowpass_dyn_min_hz=parseInt(e('.pid_filter input[name="gyroLowpassDynMinFrequency"]').val()),t.FILTER_CONFIG.gyro_lowpass_dyn_max_hz=parseInt(e('.pid_filter input[name="gyroLowpassDynMaxFrequency"]').val()),t.FILTER_CONFIG.dterm_lowpass_dyn_min_hz=parseInt(e('.pid_filter input[name="dtermLowpassDynMinFrequency"]').val()),t.FILTER_CONFIG.dterm_lowpass_dyn_max_hz=parseInt(e('.pid_filter input[name="dtermLowpassDynMaxFrequency"]').val()),t.ADVANCED_TUNING.dMaxRoll=parseInt(e('.pid_tuning input[name="dMaxRoll"]').val()),t.ADVANCED_TUNING.dMaxPitch=parseInt(e('.pid_tuning input[name="dMaxPitch"]').val()),t.ADVANCED_TUNING.dMaxYaw=parseInt(e('.pid_tuning input[name="dMaxYaw"]').val()),t.ADVANCED_TUNING.dMaxGain=parseInt(e('.dMaxGroup input[name="dMaxGain"]').val()),t.ADVANCED_TUNING.dMaxAdvance=parseInt(e('.dMaxGroup input[name="dMaxAdvance"]').val()),t.ADVANCED_TUNING.useIntegratedYaw=e('input[id="useIntegratedYaw"]').is(":checked")?1:0,t.FILTER_CONFIG.dyn_notch_range=parseInt(e('.pid_filter select[name="dynamicNotchRange"]').val()),t.FILTER_CONFIG.dyn_notch_width_percent=parseInt(e('.pid_filter input[name="dynamicNotchWidthPercent"]').val()),t.FILTER_CONFIG.dyn_notch_q=parseInt(e('.pid_filter input[name="dynamicNotchQ"]').val()),t.FILTER_CONFIG.dyn_notch_min_hz=parseInt(e('.pid_filter input[name="dynamicNotchMinHz"]').val());const j=e(".pid_filter #rpmFilterEnabled").is(":checked");t.FILTER_CONFIG.gyro_rpm_notch_harmonics=j?parseInt(e('.pid_filter input[name="rpmFilterHarmonics"]').val()):0,t.FILTER_CONFIG.gyro_rpm_notch_min_hz=parseInt(e('.pid_filter input[name="rpmFilterMinHz"]').val()),t.FILTER_CONFIG.dyn_notch_max_hz=parseInt(e('.pid_filter input[name="dynamicNotchMaxHz"]').val()),t.ADVANCED_TUNING.motorOutputLimit=parseInt(e('.tab-pid_tuning input[name="motorLimit"]').val()),t.ADVANCED_TUNING.autoProfileCellCount=parseInt(e('.tab-pid_tuning select[name="cellCount"]').val()),t.ADVANCED_TUNING.idleMinRpm=parseInt(e('input[name="idleMinRpm-number"]').val());const B=e('select[id="ratesType"]').val();let b;B!==t.RC_TUNING.rates_type&&(b=e('select[id="ratesType"]').find("option:selected").text()),i.analyticsChanges.RatesType=b,t.RC_TUNING.rates_type=B,t.ADVANCED_TUNING.feedforward_averaging=e('select[id="feedforwardAveraging"]').val(),t.ADVANCED_TUNING.feedforward_smooth_factor=parseInt(e('input[name="feedforwardSmoothFactor"]').val()),t.ADVANCED_TUNING.feedforward_boost=parseInt(e('input[name="feedforwardBoost"]').val()),t.ADVANCED_TUNING.feedforward_max_rate_limit=parseInt(e('input[name="feedforwardMaxRateLimit"]').val()),t.ADVANCED_TUNING.feedforward_jitter_factor=parseInt(e('input[name="feedforwardJitterFactor"]').val()),t.FILTER_CONFIG.dyn_lpf_curve_expo=parseInt(e('.pid_filter input[name="dtermLowpassDynExpo"]').val()),t.ADVANCED_TUNING.vbat_sag_compensation=e('input[id="vbatSagCompensation"]').is(":checked")?parseInt(e('input[name="vbatSagValue"]').val()):0,t.ADVANCED_TUNING.thrustLinearization=e('input[id="thrustLinearization"]').is(":checked")?parseInt(e('input[name="thrustLinearValue"]').val()):0,t.FILTER_CONFIG.dyn_lpf_curve_expo=parseInt(e('.pid_filter input[name="dtermLowpassExpo"]').val());const Q=e('.pid_filter input[id="dynamicNotchEnabled"]').is(":checked");t.FILTER_CONFIG.dyn_notch_count=Q?parseInt(e('.pid_filter input[name="dynamicNotchCount"]').val()):0,t.TUNING_SLIDERS.slider_pids_mode=s.sliderPidsMode,t.TUNING_SLIDERS.slider_master_multiplier=Math.round(s.sliderMasterMultiplier*20)*5,t.TUNING_SLIDERS.slider_d_gain=Math.round(s.sliderDGain*20)*5,t.TUNING_SLIDERS.slider_pi_gain=Math.round(s.sliderPIGain*20)*5,t.TUNING_SLIDERS.slider_feedforward_gain=Math.round(s.sliderFeedforwardGain*20)*5,t.TUNING_SLIDERS.slider_i_gain=Math.round(s.sliderIGain*20)*5,t.TUNING_SLIDERS.slider_dmax_gain=Math.round(s.sliderDMaxGain*20)*5,t.TUNING_SLIDERS.slider_roll_pitch_ratio=Math.round(s.sliderRollPitchRatio*20)*5,t.TUNING_SLIDERS.slider_pitch_pi_gain=Math.round(s.sliderPitchPIGain*20)*5,t.TUNING_SLIDERS.slider_dterm_filter=s.sliderDTermFilter,t.TUNING_SLIDERS.slider_dterm_filter_multiplier=Math.round(s.sliderDTermFilterMultiplier*20)*5,t.TUNING_SLIDERS.slider_gyro_filter=s.sliderGyroFilter,t.TUNING_SLIDERS.slider_gyro_filter_multiplier=Math.round(s.sliderGyroFilterMultiplier*20)*5}function _(){e(".pid_optional tr").hide(),e(".pid_optional table").hide(),e(".pid_optional").hide(),t.PID_NAMES.forEach(function(m){e(`.pid_tuning .${m}`).show(),e(`.needed_by_${m}`).show()})}function p(){rt(t.CONFIG.activeSensors,"acc")||(e("#pid_accel").hide(),e(".acroTrainerAngleLimit").hide()),e("#pid_baro_mag_gps").hide()}function E(m,N,I){m.strokeStyle="#888888",m.lineWidth=4,m.beginPath(),m.moveTo(0,I/2),m.lineTo(N,I/2),m.stroke(),m.beginPath(),m.moveTo(N/2,0),m.lineTo(N/2,I),m.stroke()}function A(m){let N=parseFloat(m.val());return(N<parseFloat(m.prop("min"))||N>parseFloat(m.prop("max")))&&(N=void 0),N}const G=!1;i.rateCurve=new at(G),e('.pid_tuning input[name="sensitivity"]').hide(),e(".pid_tuning .levelSensitivityHeader").empty();function k(m,N,I,C,w,D,x){const S=i.rateCurve.getMaxAngularVel(m,N,I,C,w,D).toFixed(0);return x.text(S),S}function Y(m,N,I,C,w,D,x,S,V,v){v.save(),v.strokeStyle=S,v.translate(0,V),i.rateCurve.draw(m,N,I,C,w,D,x,v),v.restore()}function pe(){if(Ue.pid_tuning.isHtmlProcessing=!0,t.FEATURE_CONFIG.features.generateElements(e(".tab-pid_tuning .features")),e(".tab-pid_tuning .pidTuningSuperexpoRates").hide(),P.lt(t.CONFIG.apiVersion,We)){const a=document.querySelector(".derivative .cf_tip"),d=document.querySelector(".dmax .cf_tip");["i18n","i18n_title"].forEach(T=>{const U=a.getAttribute(T);a.setAttribute(T,d.getAttribute(T)),d.setAttribute(T,U)})}F.localizePage(),i.currentRates=i.rateCurve.getCurrentRates(),e(".tab-pid_tuning .tab-container .pid").on("click",()=>ee("pid")),e(".tab-pid_tuning .tab-container .rates").on("click",()=>ee("rates")),e(".tab-pid_tuning .tab-container .filter").on("click",()=>ee("filter"));function m(){const a=t.CONFIG.numProfiles,d=[];for(let T=0;T<a;T++)d.push(F.getMessage("pidTuningProfileOption",[T+1]));return d}function N(){let a=6;P.gte(t.CONFIG.apiVersion,z)&&(a=4),P.gte(t.CONFIG.apiVersion,We)&&(a=t.CONFIG.numberOfRateProfiles);const d=[];for(let T=0;T<a;T++)d.push(F.getMessage("pidTuningRateProfileOption",[T+1]));return d}const I=N(),C=m();function w(a){const d=e('select[name="profile"]');a.forEach(function(T,U){d.append(`<option value="${U}">${T}</option>`)})}w(C);function D(a){const d=e('select[name="rate_profile"]');a.forEach(function(T,U){d.append(`<option value="${U}">${T}</option>`)})}D(I);const x=e("#showAllPids");function S(){i.showAllPids?(_(),x.text(F.getMessage("pidTuningHideUnusedPids"))):(p(),x.text(F.getMessage("pidTuningShowAllPids")))}_(),S(),x.on("click",function(){i.showAllPids=!i.showAllPids,S()}),e("#resetPidProfile").on("click",function(){i.updating=!0,y.promise(h.MSP_SET_RESET_CURR_PID).then(function(){i.refresh(function(){i.updating=!1,ve(F.getMessage("pidTuningPidProfileReset"))})})}),e('.tab-pid_tuning select[name="profile"]').change(function(){i.currentProfile=parseInt(e(this).val()),i.updating=!0,e(this).prop("disabled","true"),y.promise(h.MSP_SELECT_SETTING,[i.currentProfile]).then(function(){i.refresh(function(){i.updating=!1,e('.tab-pid_tuning select[name="profile"]').prop("disabled","false"),t.CONFIG.profile=i.currentProfile,ve(F.getMessage("pidTuningLoadedProfile",[i.currentProfile+1]))})})}),e('.tab-pid_tuning select[name="rate_profile"]').change(function(){i.currentRateProfile=parseInt(e(this).val()),i.updating=!0,e(this).prop("disabled","true"),y.promise(h.MSP_SELECT_SETTING,[i.currentRateProfile+i.RATE_PROFILE_MASK]).then(function(){i.refresh(function(){i.updating=!1,e('.tab-pid_tuning select[name="rate_profile"]').prop("disabled","false"),t.CONFIG.rateProfile=i.currentRateProfile,i.currentRates=i.rateCurve.getCurrentRates(),ve(F.getMessage("pidTuningLoadedRateProfile",[i.currentRateProfile+1]))})})});const V=e('input[name="dtermSetpointTransition-number"]'),v=e("#pid-tuning .dtermSetpointTransitionWarning");function j(a){a>0&&a<.1?v.show():v.hide()}j(V.val()),V.on("input",function(){j(e(this).val())}),e("#pid-tuning .delta").hide(),e(".tab-pid_tuning .note").hide(),e(".pid_tuning tr").each(function(){for(const a of t.PID_NAMES)if(e(this).hasClass(a)){const d=e(this).find("td:first");d.text()||d.text(a)}});function B(){const a=[];return a.push("PT1"),a.push("BIQUAD"),a.push("PT2"),a.push("PT3"),a}function b(a,d){const T=e(`select[name="${a}"]`);d.forEach(function(U,me){T.append(`<option value="${me}">${U}</option>`)})}function Q(){return["HIGH","MEDIUM","LOW","AUTO"]}function oe(a){const d=e('select[name="dynamicNotchRange"]');a.forEach(function(T,U){d.append(`<option value="${U}">${T}</option>`)})}oe(Q()),b("gyroLowpassType",B()),b("gyroLowpass2Type",B()),b("dtermLowpassType",B()),b("dtermLowpass2Type",B()),n();function ee(a){const d=["pid","rates","filter"];if(!d.includes(a)){console.debug(`Invalid subtab name: "${a}"`);return}for(const T of d)e(`.tab-pid_tuning .subtab-${T}`)[T===a?"show":"hide"]();e(".tab-pid_tuning .tab-container .tab").removeClass("active"),e(`.tab-pid_tuning .tab-container .${a}`).addClass("active"),i.activeSubtab=a,a==="rates"?(le(!0),i.throttleDrawInterval=setInterval(le,100)):i.throttleDrawInterval&&(clearInterval(i.throttleDrawInterval),i.throttleDrawInterval=null)}ee(i.activeSubtab),e(".tab-pid_tuning div.controller").hide(),i.updatePidControllerParameters(),e(".pid_tuning .roll_pitch_rate").hide(),P.gte(t.CONFIG.apiVersion,z)?e(".tpa-old").hide():e(".tpa").hide(),e(".pid_tuning .bracket").hide(),e(".pid_tuning input[name=rc_rate]").parent().attr("class","pid_data"),e(".pid_tuning input[name=rc_rate]").parent().attr("rowspan",1),e(".pid_tuning input[name=rc_expo]").parent().attr("class","pid_data"),e(".pid_tuning input[name=rc_expo]").parent().attr("rowspan",1);const J=e(".rate_curve canvas#rate_curve_layer0").get(0),M=J.getContext("2d");let q=!0,H;i.maxAngularVelRollElement=e(".pid_tuning .maxAngularVelRoll"),i.maxAngularVelPitchElement=e(".pid_tuning .maxAngularVelPitch"),i.maxAngularVelYawElement=e(".pid_tuning .maxAngularVelYaw"),i.acroCenterSensitivityRollElement=e(".pid_tuning .acroCenterSensitivityRoll"),i.acroCenterSensitivityPitchElement=e(".pid_tuning .acroCenterSensitivityPitch"),i.acroCenterSensitivityYawElement=e(".pid_tuning .acroCenterSensitivityYaw"),J.width=1e3,J.height=1e3;function de(a){setTimeout(function(){if(a){const d=e(a.target);let T=A(d);if(i.currentRates.hasOwnProperty(d.attr("name"))&&T!==void 0){const U=parseFloat(d.prop("step"));U!=null&&(T=Math.round(T/U)*U),i.currentRates[d.attr("name")]=T,q=!0}d.attr("name")==="SUPEREXPO_RATES"&&(i.currentRates.superexpo=d.is(":checked"),q=!0),d.attr("id")==="ratesType"&&(i.changeRatesType(T),q=!0)}else q=!0;if(q){const d=J.height,T=J.width,U=M.canvas.width/M.canvas.clientWidth;M.clearRect(0,0,T,d),H=Math.max(k(i.currentRates.roll_rate,i.currentRates.rc_rate,i.currentRates.rc_expo,i.currentRates.superexpo,i.currentRates.deadband,i.currentRates.roll_rate_limit,i.maxAngularVelRollElement),k(i.currentRates.pitch_rate,i.currentRates.rc_rate_pitch,i.currentRates.rc_pitch_expo,i.currentRates.superexpo,i.currentRates.deadband,i.currentRates.pitch_rate_limit,i.maxAngularVelPitchElement),k(i.currentRates.yaw_rate,i.currentRates.rc_rate_yaw,i.currentRates.rc_yaw_expo,i.currentRates.superexpo,i.currentRates.yawDeadband,i.currentRates.yaw_rate_limit,i.maxAngularVelYawElement)),H=i.rateCurve.setMaxAngularVel(H),E(M,T,d),M.lineWidth=2*U,Y(i.currentRates.roll_rate,i.currentRates.rc_rate,i.currentRates.rc_expo,i.currentRates.superexpo,i.currentRates.deadband,i.currentRates.roll_rate_limit,H,"#ff0000",0,M),Y(i.currentRates.pitch_rate,i.currentRates.rc_rate_pitch,i.currentRates.rc_pitch_expo,i.currentRates.superexpo,i.currentRates.deadband,i.currentRates.pitch_rate_limit,H,"#00ff00",-4,M),Y(i.currentRates.yaw_rate,i.currentRates.rc_rate_yaw,i.currentRates.rc_yaw_expo,i.currentRates.superexpo,i.currentRates.yawDeadband,i.currentRates.yaw_rate_limit,H,"#0000ff",4,M),i.updateRatesLabels(),q=!1}},0)}e("input.feature").on("input change",function(){const a=e(this);t.FEATURE_CONFIG.features.updateData(a),de()}),e(".pid_tuning").on("input change",de).trigger("input");function le(a=!1){if(!a&&!i.checkThrottle())return;function d(re,_e,W,Te){const ne=1-re;return ne*ne*_e+2*ne*re*W+re*re*Te}function T(re,_e,W,Te,ne,xe,Ve){return{x:d(Ve,re,W,ne),y:d(Ve,_e,Te,xe)}}function U(re,_e,W,Te){const ne=_e+Te-2*W,xe=2*(W-_e),Ve=_e-re;return ne==0?-Ve/xe:(-xe-Math.sqrt(Math.pow(xe,2)-4*ne*Ve))/(2*ne)}const me={OFF:0,SCALE:1,CLIP:2},Ce=e('.throttle input[name="mid"]'),Oe=e('.throttle input[name="expo"]'),ze=e('.throttle_limit input[name="throttleLimitPercent"]'),ke=e('.throttle_limit select[id="throttleLimitType"]'),se=parseFloat(Ce.val()),ge=parseFloat(Oe.val()),fe=parseInt(ze.val())/100,l=parseInt(ke.val()),u=e(".throttle .throttle_curve canvas").get(0),f=u.getContext("2d");if(!(se>=parseFloat(Ce.prop("min"))&&se<=parseFloat(Ce.prop("max"))&&ge>=parseFloat(Oe.prop("min"))&&ge<=parseFloat(Oe.prop("max"))))return;u.width=u.height*(u.clientWidth/u.clientHeight);const $=l===me.SCALE?fe:1,O=u.height,te=u.width,Ae=O*(1-$),X=te*se,Ye=X*.5,qe=(te-X)*.5+X,ie=O-$*(X*(O/te)),Se=O-(O-ie)*.5*(ge+1),Me=Ae+(ie-Ae)*.5*(ge+1);let Pe=(t.RC.channels[3]-1e3)/1e3,we=Pe<=se?T(0,O,Ye,Se,X,ie,Pe*(1/se)):T(X,ie,qe,Me,te,Ae,(Pe-se)*(1/(1-se)));if(f.clearRect(0,0,te,O),f.beginPath(),f.moveTo(0,O),l===me.CLIP){const re=O*(1-fe);we.y=we.y<re?re:we.y;const _e=fe<=se?U(re,O,Se,ie):U(re,ie,Me,Ae);let W=T(0,O,Ye,Se,X,ie,_e),Te=W.x/2,ne=Se+(O-Se)*(X-W.x)/X;fe>se&&(f.quadraticCurveTo(Ye,Se,X,ie),f.moveTo(X,ie),W=T(X,ie,qe,Me,te,Ae,_e),Te=X+(W.x-X)/2,ne=Me+(ie-Me)*(te-W.x)/(te-X)),f.quadraticCurveTo(Te,ne,W.x,W.y),f.moveTo(W.x,W.y),f.lineTo(te,W.y)}else f.quadraticCurveTo(Ye,Se,X,ie),f.moveTo(X,ie),f.quadraticCurveTo(qe,Me,te,Ae);f.lineWidth=2,f.strokeStyle="#ffbb00",f.stroke(),f.beginPath(),f.arc(we.x,we.y,4,0,2*Math.PI),f.fillStyle=f.strokeStyle,f.fill(),f.save();let $e=10;f.font=`${$e}pt Verdana, Arial, sans-serif`;let je=Pe*100,Je=100-we.y/O*100,Be=`${Math.round(Pe<=0?0:je)}% = ${Math.round(Pe<=0?0:Je)}%`,Ze=f.measureText(Be);f.fillStyle="#888888",f.scale(Ze/u.clientWidth,1),f.fillText(Be,5,5+$e),f.restore()}e(".throttle input, .throttle_limit input, .throttle_limit select").on("change",()=>setTimeout(()=>le(!0),0)),e("a.refresh").click(function(){i.refresh(function(){ve(F.getMessage("pidTuningDataRefreshed"))})}),e("#pid-tuning").find("input").each(function(a,d){e(d).attr("class")!=="feature toggle"&&e(d).attr("class")!=="nonProfile"&&e(d).change(function(){i.setDirty(!0)})});const ae=e(".dialogCopyProfile")[0],ce=0,Ee=1;let he;const Ne=e(".selectProfile"),Ie=e(".selectRateProfile");e.each(C,function(a,d){a!==t.CONFIG.profile&&Ne.append(new Option(d,a))}),e.each(I,function(a,d){a!==t.CONFIG.rateProfile&&Ie.append(new Option(d,a))}),e(".copyprofilebtn").click(function(){e(".dialogCopyProfile").find(".contentProfile").show(),e(".dialogCopyProfile").find(".contentRateProfile").hide(),he=ce,ae.showModal()}),e(".copyrateprofilebtn").click(function(){e(".dialogCopyProfile").find(".contentProfile").hide(),e(".dialogCopyProfile").find(".contentRateProfile").show(),he=Ee,ae.showModal()}),e(".dialogCopyProfile-cancelbtn").click(function(){ae.close()}),e(".dialogCopyProfile-confirmbtn").click(function(){switch(he){case ce:t.COPY_PROFILE.type=ce,t.COPY_PROFILE.dstProfile=parseInt(Ne.val()),t.COPY_PROFILE.srcProfile=t.CONFIG.profile,y.send_message(h.MSP_COPY_PROFILE,K.crunch(h.MSP_COPY_PROFILE),!1,a);break;case Ee:t.COPY_PROFILE.type=Ee,t.COPY_PROFILE.dstProfile=parseInt(Ie.val()),t.COPY_PROFILE.srcProfile=t.CONFIG.rateProfile,y.send_message(h.MSP_COPY_PROFILE,K.crunch(h.MSP_COPY_PROFILE),!1,a);break;default:a();break}function a(){ae.close()}}),s.initialize();const Fe=1.4,Ge=.7,De=e("#sliderPidsModeSelect"),be=e("#sliderGyroFilterModeSelect"),Le=e("#sliderDTermFilterModeSelect"),Z=e('input[id="useIntegratedYaw"]');Z.on("change",()=>{Z.is(":checked")&&s.sliderPidsMode&&De.val(1).trigger("change")}),De.on("change",function(){const a=parseInt(e(this).val());s.sliderPidsMode=a,s.calculateNewPids(),s.updatePidSlidersDisplay(),a===2&&Z.prop("checked",!1).trigger("change")}),be.change(function(){parseInt(e(this).find(":selected").val())===1?s.gyroFilterSliderEnable():s.gyroFilterSliderDisable()}),Le.change(function(){parseInt(e(this).find(":selected").val())!==0?s.dtermFilterSliderEnable():s.dtermFilterSliderDisable()});const ue=e("#sliderMasterMultiplier, #sliderDGain, #sliderPIGain, #sliderFeedforwardGain, #sliderIGain, #sliderDMaxGain, #sliderRollPitchRatio, #sliderPitchPIGain");e(".tab-pid-tuning .legacySlider").hide(),ue.on("input mouseup",function(){const a=e(this);s.expertMode||(a.val()>Fe?a.val(Fe):a.val()<Ge&&a.val(Ge));const d=He(a.val())?parseInt(a.val()):parseFloat(a.val());a.is("#sliderDGain")?s.sliderDGain=d:a.is("#sliderPIGain")?s.sliderPIGain=d:a.is("#sliderFeedforwardGain")?s.sliderFeedforwardGain=d:a.is("#sliderDMaxGain")?s.sliderDMaxGain=d:a.is("#sliderIGain")?s.sliderIGain=d:a.is("#sliderRollPitchRatio")?s.sliderRollPitchRatio=d:a.is("#sliderPitchPIGain")?s.sliderPitchPIGain=d:a.is("#sliderMasterMultiplier")&&(s.sliderMasterMultiplier=d),i.calculateNewPids(),i.analyticsChanges.PidTuningSliders="On"}),ue.each(function(a){i.sliderOnScroll(e(this))}),ue.dblclick(function(){const a=e(this);let d;a.is("#sliderDGain")?(d=t.DEFAULT_TUNING_SLIDERS.slider_d_gain/100,s.sliderDGain=d):a.is("#sliderPIGain")?(d=t.DEFAULT_TUNING_SLIDERS.slider_pi_gain/100,s.sliderPIGain=d):a.is("#sliderFeedforwardGain")?(d=t.DEFAULT_TUNING_SLIDERS.slider_feedforward_gain/100,s.sliderFeedforwardGain=d):a.is("#sliderDMaxGain")?(d=t.DEFAULT_TUNING_SLIDERS.slider_dmax_gain/100,s.sliderDMaxGain=d):a.is("#sliderIGain")?(d=t.DEFAULT_TUNING_SLIDERS.slider_i_gain/100,s.sliderIGain=d):a.is("#sliderRollPitchRatio")?(d=t.DEFAULT_TUNING_SLIDERS.slider_roll_pitch_ratio/100,s.sliderRollPitchRatio=d):a.is("#sliderPitchPIGain")?(d=t.DEFAULT_TUNING_SLIDERS.slider_pitch_pi_gain/100,s.sliderPitchPIGain=d):a.is("#sliderMasterMultiplier")&&(d=t.DEFAULT_TUNING_SLIDERS.slider_master_multiplier/100,s.sliderMasterMultiplier=d),a.val(d),i.calculateNewPids()});const ye=e("#sliderGyroFilterMultiplier, #sliderDTermFilterMultiplier");ye.on("input mouseup",function(){const a=e(this);s.expertMode||(a.is("#sliderGyroFilterMultiplier")?a.val()>1.5?a.val(1.5):a.val()<.5&&a.val(.5):a.is("#sliderDTermFilterMultiplier")&&(a.val()>1.2?a.val(1.2):a.val()<.8&&a.val(.8)));let d=He(a.val())?parseInt(a.val()):parseFloat(a.val());a.is("#sliderGyroFilterMultiplier")?(s.sliderGyroFilterMultiplier=d,i.calculateNewGyroFilters(),i.analyticsChanges.GyroFilterTuningSlider="On"):a.is("#sliderDTermFilterMultiplier")&&(s.sliderDTermFilterMultiplier=d,i.calculateNewDTermFilters(),i.analyticsChanges.DTermFilterTuningSlider="On")}),ye.each(function(){i.sliderOnScroll(e(this))}),ye.dblclick(function(){const a=e(this);a.val(1),a.is("#sliderGyroFilterMultiplier")?(s.sliderGyroFilterMultiplier=1,i.calculateNewGyroFilters()):a.is("#sliderDTermFilterMultiplier")&&(s.sliderDTermFilterMultiplier=1,i.calculateNewDTermFilters())}),e(".pid_filter tr:not(.newFilter) input, .pid_filter tr:not(.newFilter) select").on("input",function(a){a.target.type==="number"?e(`.pid_filter input[name="${a.target.name}"]`).val(a.target.value):a.target.type==="select-one"&&e(`.pid_filter select[name="${a.target.name}"]`).val(a.target.value),s.GyroSliderUnavailable&&(i.analyticsChanges.GyroFilterTuningSlider="Off"),s.DTermSliderUnavailable&&(i.analyticsChanges.DTermFilterTuningSlider="Off")}),e(".pid_filter tr:not(.newFilter) .inputSwitch input").change(()=>{e(".pid_filter input").triggerHandler("input"),i.setDirty(!0)}),e(".tuningHelp").hide(),e("#pid-tuning .delta select").change(function(){i.setDirty(!0)}),e("a.update").click(function(){R(),i.updating=!0,y.promise(h.MSP_SET_PID,K.crunch(h.MSP_SET_PID)).then(()=>y.promise(h.MSP_SET_PID_ADVANCED,K.crunch(h.MSP_SET_PID_ADVANCED))).then(()=>P.gte(t.CONFIG.apiVersion,z)?y.promise(h.MSP2_SET_TEXT,K.crunch(h.MSP2_SET_TEXT,h.PID_PROFILE_NAME)):!0).then(()=>P.gte(t.CONFIG.apiVersion,z)?y.promise(h.MSP2_SET_TEXT,K.crunch(h.MSP2_SET_TEXT,h.RATE_PROFILE_NAME)):!0).then(()=>(i.updatePIDColors(),y.promise(h.MSP_SET_FILTER_CONFIG,K.crunch(h.MSP_SET_FILTER_CONFIG)))).then(()=>y.promise(h.MSP_SET_RC_TUNING,K.crunch(h.MSP_SET_RC_TUNING))).then(()=>y.promise(h.MSP_SET_FEATURE_CONFIG,K.crunch(h.MSP_SET_FEATURE_CONFIG))).then(()=>y.promise(h.MSP_SET_SIMPLIFIED_TUNING,K.crunch(h.MSP_SET_SIMPLIFIED_TUNING))).then(()=>y.promise(h.MSP_EEPROM_WRITE)).then(()=>{i.updating=!1,i.setDirty(!1),ve(F.getMessage("pidTuningEepromSaved")),i.refresh()}),Qe.sendSaveAndChangeEvents(Qe.EVENT_CATEGORIES.FLIGHT_CONTROLLER,i.analyticsChanges,"pid_tuning"),i.analyticsChanges={}}),i.initRatesPreview(),i.renderModel(),i.updating=!1,Re.interval_add("receiver_pull",i.getReceiverData,250,!0),Re.interval_add("update_profile",function(){i.checkUpdateProfile(!0)},500,!0),i.analyticsChanges={},Re.content_ready(r),Ue.pid_tuning.isHtmlProcessing=!1}};L.getReceiverData=function(){y.send_message(h.MSP_RC,!1,!1)};L.initRatesPreview=function(){this.keepRendering=!0,this.model=new tt(e(".rates_preview"),e(".rates_preview canvas")),e(".tab-pid_tuning .tab-container .rates").on("click",e.proxy(this.model.resize,this.model)),e(".tab-pid_tuning .tab-container .rates").on("click",e.proxy(this.updateRatesLabels,this)),e(window).on("resize",e.proxy(this.model.resize,this.model)),e(window).on("resize",e.proxy(this.updateRatesLabels,this))};L.renderModel=function(){if(this.keepRendering&&(requestAnimationFrame(this.renderModel.bind(this)),this.clock||(this.clock=new it),t.RC.channels[0]&&t.RC.channels[1]&&t.RC.channels[2])){const r=this.clock.getDelta(),i=r*this.rateCurve.rcCommandRawToDegreesPerSecond(t.RC.channels[0],this.currentRates.roll_rate,this.currentRates.rc_rate,this.currentRates.rc_expo,this.currentRates.superexpo,this.currentRates.deadband,this.currentRates.roll_rate_limit),o=r*this.rateCurve.rcCommandRawToDegreesPerSecond(t.RC.channels[1],this.currentRates.pitch_rate,this.currentRates.rc_rate_pitch,this.currentRates.rc_pitch_expo,this.currentRates.superexpo,this.currentRates.deadband,this.currentRates.pitch_rate_limit),c=r*this.rateCurve.rcCommandRawToDegreesPerSecond(t.RC.channels[2],this.currentRates.yaw_rate,this.currentRates.rc_rate_yaw,this.currentRates.rc_yaw_expo,this.currentRates.superexpo,this.currentRates.yawDeadband,this.currentRates.yaw_rate_limit);this.model.rotateBy(-Xe(o),-Xe(c),-Xe(i)),this.checkRC()&&this.updateRatesLabels()}};L.cleanup=function(r){const i=this;i.keepRendering=!1,i.model&&(e(window).off("resize",e.proxy(i.model.resize,i.model)),i.model.dispose()),e(window).off("resize",e.proxy(this.updateRatesLabels,this)),i.throttleDrawInterval&&clearInterval(i.throttleDrawInterval),r&&r()};L.refresh=function(r){const i=this;Re.tab_switch_cleanup(function(){i.initialize(),i.setDirty(!1),r&&r()})};L.setProfile=function(){const r=this;r.currentProfile=t.CONFIG.profile,e('.tab-pid_tuning select[name="profile"]').val(r.currentProfile)};L.setRateProfile=function(){const r=this;r.currentRateProfile=t.CONFIG.rateProfile,e('.tab-pid_tuning select[name="rate_profile"]').val(r.currentRateProfile)};L.setDirty=function(r){const i=this;i.dirty=r,e('.tab-pid_tuning select[name="profile"]').prop("disabled",r),e('.tab-pid_tuning select[name="rate_profile"]').prop("disabled",r)};L.checkUpdateProfile=function(r){const i=this;if(Re.active_tab==="pid_tuning"&&!i.updating&&!i.dirty){let o=!1;i.currentProfile!==t.CONFIG.profile&&(i.setProfile(),o=!0);let c=!1;r&&i.currentRateProfile!==t.CONFIG.rateProfile&&(i.setRateProfile(),c=!0),(o||c)&&(i.updating=!0,i.refresh(function(){i.updating=!1,o&&(ve(F.getMessage("pidTuningReceivedProfile",[t.CONFIG.profile+1])),t.CONFIG.profile=i.currentProfile),c&&(ve(F.getMessage("pidTuningReceivedRateProfile",[t.CONFIG.rateProfile+1])),t.CONFIG.rateProfile=i.currentRateProfile)}))}};L.checkRC=function(){this.oldRC||(this.oldRC=[t.RC.channels[0],t.RC.channels[1],t.RC.channels[2]]);let r=!1;for(let i=0;i<this.oldRC.length;i++)this.oldRC[i]!==t.RC.channels[i]&&(this.oldRC[i]=t.RC.channels[i],r=!0);return r};L.checkThrottle=function(){if(!this.oldThrottle)return this.oldThrottle=t.RC.channels[3],!0;const r=this.oldThrottle!==t.RC.channels[3];return this.oldThrottle=t.RC.channels[3],r};L.updatePidControllerParameters=function(){e(".pid_tuning .YAW_JUMP_PREVENTION").hide(),e("#pid-tuning .dtermSetpointTransition").hide(),e("#pid-tuning .dtermSetpoint").hide(),e("#pid-tuning .delta").hide()};L.updateRatesLabels=function(){const r=this;if(!r.rateCurve.useLegacyCurve&&r.rateCurve.maxAngularVel){const i=function(n,R,_,p,E,A){n.fillStyle=A||"#888888",n.textAlign=E||"center",n.fillText(R,_,p)},o=function(n,R,_,p,E,A,G){const m=parseInt(n.font),N=n.measureText(R).width*1.2,I=m*1.5,C=p;n.fillStyle=A.color||"#ffffff",n.strokeStyle=A.border||"#000000",_*=n.canvas.clientWidth/n.canvas.clientHeight,_+=(E=="right"?-(N+125):0)+(E=="left"?125:0),p-=I/2,p<0?p=0:p>n.height&&(p=n.height);for(let D=0;D<G.length;D++)(_>=G[D].left&&_<=G[D].right||_+N>=G[D].left&&_+N<=G[D].right)&&(p>=G[D].top&&p<=G[D].bottom||p+I>=G[D].top&&p+I<=G[D].bottom)&&(p<=(G[D].bottom-G[D].top)/2&&G[D].top-I>0?p=G[D].top-I:p=G[D].bottom);G.push({left:_,right:_+N,top:p-5,bottom:p+I+5});const w=(I-2*10)/6;n.beginPath(),n.moveTo(_+10,p),n.lineTo(_+N-10,p),n.quadraticCurveTo(_+N,p,_+N,p+10),E==="right"&&(n.lineTo(_+N,p+10+w),n.lineTo(_+N+125,C),n.lineTo(_+N,p+I-10-w)),n.lineTo(_+N,p+I-10),n.quadraticCurveTo(_+N,p+I,_+N-10,p+I),n.lineTo(_+10,p+I),n.quadraticCurveTo(_,p+I,_,p+I-10),E==="left"&&(n.lineTo(_,p+I-10-w),n.lineTo(_-125,C),n.lineTo(_,p+10-w)),n.lineTo(_,p+10),n.quadraticCurveTo(_,p,_+10,p),n.closePath(),n.fill(),n.stroke(),i(n,R,_+N/2,p+(I+m)/2-4,"center",A.text)},c={roll:{color:"rgba(255,128,128,0.4)",border:"rgba(255,128,128,0.6)",text:"#000000"},pitch:{color:"rgba(128,255,128,0.4)",border:"rgba(128,255,128,0.6)",text:"#000000"},yaw:{color:"rgba(128,128,255,0.4)",border:"rgba(128,128,255,0.6)",text:"#000000"}},g=e(".rate_curve canvas#rate_curve_layer1").get(0);if(g){let ee=function(M){return k-Math.ceil(n.measureText(M).width)/(n.canvas.clientWidth/n.canvas.clientHeight)-40};g.width=1e3,g.height=1e3;const n=g.getContext("2d");n.save();const R=`${r.maxAngularVelRollElement.text()} deg/s`,_=`${r.maxAngularVelPitchElement.text()} deg/s`,p=`${r.maxAngularVelYawElement.text()} deg/s`;let E=[],A=[];const G=g.height,k=g.width,Y=r.rateCurve.maxAngularVel,pe=400/n.canvas.clientHeight,m=G/2/Y,N=n.canvas.width/n.canvas.clientWidth,I=n.canvas.clientHeight/n.canvas.clientWidth;n.clearRect(0,0,k,G),pe<=1?n.font="24pt Verdana, Arial, sans-serif":n.font=`${24*pe}pt Verdana, Arial, sans-serif`,t.RC.channels[0]&&t.RC.channels[1]&&t.RC.channels[2]?(E.push(`${r.rateCurve.drawStickPosition(t.RC.channels[0],r.currentRates.roll_rate,r.currentRates.rc_rate,r.currentRates.rc_expo,r.currentRates.superexpo,r.currentRates.deadband,r.currentRates.roll_rate_limit,Y,n,"#FF8080")} deg/s`),E.push(`${r.rateCurve.drawStickPosition(t.RC.channels[1],r.currentRates.pitch_rate,r.currentRates.rc_rate_pitch,r.currentRates.rc_pitch_expo,r.currentRates.superexpo,r.currentRates.deadband,r.currentRates.pitch_rate_limit,Y,n,"#80FF80")} deg/s`),E.push(`${r.rateCurve.drawStickPosition(t.RC.channels[2],r.currentRates.yaw_rate,r.currentRates.rc_rate_yaw,r.currentRates.rc_yaw_expo,r.currentRates.superexpo,r.currentRates.yawDeadband,r.currentRates.yaw_rate_limit,Y,n,"#8080FF")} deg/s`)):E=[],n.lineWidth=N,n.scale(I,1),i(n,`${Y.toFixed(0)} deg/s`,(k/2-10)/I,parseInt(n.font)*1.2,"right"),A=[];const C=[{value:parseInt(R),balloon:function(){o(n,R,k,m*(Y-parseInt(R)),"right",c.roll,A)}},{value:parseInt(_),balloon:function(){o(n,_,k,m*(Y-parseInt(_)),"right",c.pitch,A)}},{value:parseInt(p),balloon:function(){o(n,p,k,m*(Y-parseInt(p)),"right",c.yaw,A)}}],w=1800,D=parseInt(R)>w||parseInt(_)>w||parseInt(p)>w;e(".maxRateWarning").toggle(D),C.sort(function(M,q){return q.value-M.value}),E[0]&&E[1]&&E[2]&&C.push({value:parseInt(E[0]),balloon:function(){o(n,E[0],10,150,"none",c.roll,A)}},{value:parseInt(E[1]),balloon:function(){o(n,E[1],10,250,"none",c.pitch,A)}},{value:parseInt(E[2]),balloon:function(){o(n,E[2],10,350,"none",c.yaw,A)}});const x=e("#pid-tuning .pid_titlebar .centerSensitivity"),S=r.currentRatesType===t.RATES_TYPE.BETAFLIGHT;x.toggle(S),r.acroCenterSensitivityRollElement.toggle(S),r.acroCenterSensitivityPitchElement.toggle(S),r.acroCenterSensitivityYawElement.toggle(S),e("#pid-tuning .pid_titlebar .maxVel").toggle(!S),r.maxAngularVelRollElement.toggle(!S),r.maxAngularVelPitchElement.toggle(!S),r.maxAngularVelYawElement.toggle(!S);const V=t.ADVANCED_TUNING.levelAngleLimit,v=parseInt(R),j=parseInt(_),B=parseInt(p),b=r.currentRates.rc_rate,Q=r.currentRates.rc_rate_pitch,oe=r.currentRates.rc_rate_yaw,J="Angle Mode";if(r.currentRatesType===t.RATES_TYPE.ACTUAL){i(n,J,(k-10)/I,G-250,"right");const M=(b/v*V).toFixed(1),q=(Q/j*V).toFixed(1),H=`${M}...${V}`,de=`${q}...${V}`,le=ee(H),ae=ee(de);C.push({value:parseInt(M),balloon:function(){o(n,H,le,G-150,"none",c.roll,A)}},{value:parseInt(q),balloon:function(){o(n,de,ae,G-50,"none",c.pitch,A)}})}if(r.currentRatesType===t.RATES_TYPE.BETAFLIGHT){i(n,J,(k-10)/I,G-250,"right");const M=14.54,q=Z=>Z>2?(Z-2)*M+2:Z,H=(Z,ue)=>((1-Z)*q(ue)*200).toFixed(0),de=(Z,ue)=>(V*((1-Z)*q(ue)*200/v)).toFixed(1),le=r.currentRates.rc_expo,ae=de(le,b),ce=`${ae} - ${V}`,Ee=ee(ce),he=H(le,b);r.acroCenterSensitivityRollElement.text(`${he} - ${v}`);const Ne=r.currentRates.rc_pitch_expo,Ie=de(Ne,Q),Fe=`${Ie} - ${V}`,Ge=ee(Fe),De=H(Ne,Q);r.acroCenterSensitivityPitchElement.text(`${De} - ${j}`);const be=r.currentRates.rc_yaw_expo,Le=H(be,oe);r.acroCenterSensitivityYawElement.text(`${Le} - ${B}`),C.push({value:parseInt(ae),balloon:function(){o(n,ce,Ee,G-150,"none",c.roll,A)}},{value:parseInt(Ie),balloon:function(){o(n,Fe,Ge,G-50,"none",c.pitch,A)}})}for(const M of C)M.balloon();n.restore()}}};L.calculateNewPids=function(){Ue.pid_tuning.isHtmlProcessing||s.calculateNewPids()};L.calculateNewGyroFilters=function(){Ue.pid_tuning.isHtmlProcessing||s.sliderGyroFilter&&s.calculateNewGyroFilters()};L.calculateNewDTermFilters=function(){Ue.pid_tuning.isHtmlProcessing||s.sliderDTermFilter&&s.calculateNewDTermFilters()};L.updateFilterWarning=function(){const r=parseInt(e('.pid_filter select[name="gyroLowpassFilterMode"]').val()),i=r===1,o=!r,c=parseInt(e('.pid_filter select[name="dtermLowpassFilterMode"]').val()),g=c===1,n=!c,R=e("#pid-tuning .filterWarning"),_=e("#pid-tuning .dynamicNotchNyquistWarningNote");R.toggle(!(i||o)||!(g||n)),_.toggle(t.CONFIG.sampleRateHz/t.PID_ADVANCED_CONFIG.pid_process_denom<2e3)};L.updatePIDColors=function(r=!1){if(P.gte(t.CONFIG.apiVersion,"1.44.0"))return;const i=function(o,c,g){if(r){o.css({"background-color":"transparent"});return}if(g===void 0||c===void 0)return;const n=(g-c)/50;o.css({"background-color":nt(n,Ke.pidSlider)})};t.PID_NAMES.forEach(function(o,c){e(`.pid_tuning .${o} input`).each(function(g){i(e(this),t.PIDS_ACTIVE[c][g],t.PIDS[c][g])})}),i(e('.pid_tuning input[name="dMaxRoll"]'),t.ADVANCED_TUNING_ACTIVE.dMaxRoll,t.ADVANCED_TUNING.dMaxRoll),i(e('.pid_tuning input[name="dMaxPitch"]'),t.ADVANCED_TUNING_ACTIVE.dMaxPitch,t.ADVANCED_TUNING.dMaxPitch),i(e('.pid_tuning input[name="dMaxYaw"]'),t.ADVANCED_TUNING_ACTIVE.dMaxYaw,t.ADVANCED_TUNING.dMaxYaw),i(e('.pid_tuning .ROLL input[name="f"]'),t.ADVANCED_TUNING_ACTIVE.feedforwardRoll,t.ADVANCED_TUNING.feedforwardRoll),i(e('.pid_tuning .PITCH input[name="f"]'),t.ADVANCED_TUNING_ACTIVE.feedforwardPitch,t.ADVANCED_TUNING.feedforwardPitch),i(e('.pid_tuning .YAW input[name="f"]'),t.ADVANCED_TUNING_ACTIVE.feedforwardYaw,t.ADVANCED_TUNING.feedforwardYaw)};L.changeRatesType=function(r){const i=this,o=e(".dialogRatesType")[0];if(i.previousRatesType==null){i.currentRatesType=r,i.changeRatesTypeLogo(),i.changeRatesSystem(!0),i.previousRatesType=i.currentRatesType;return}o.hasAttribute("open")||(o.showModal(),e(".dialogRatesType-cancelbtn").click(function(){e('.rates_type select[id="ratesType"]').val(i.currentRatesType),i.previousRatesType=i.currentRatesType,o.close()}),e(".dialogRatesType-confirmbtn").click(function(){i.currentRatesType=r,i.changeRatesTypeLogo(),i.changeRatesSystem(!1),i.previousRatesType=i.currentRatesType,o.close(),t.RC_TUNING.rates_type=i.currentRatesType,i.currentRates=i.rateCurve.getCurrentRates()}))};L.changeRatesSystem=function(r){const i=this;let o=2.55,c=.01,g=.01,n=1,R=.01,_=1,p=.01,E=0;const A=0,G=e('.pid_tuning input[name="pitch_rate"]'),k=e('.pid_tuning input[name="roll_rate"]'),Y=e('.pid_tuning input[name="yaw_rate"]'),pe=e('.pid_tuning input[name="rc_rate_pitch"]'),m=e('.pid_tuning input[name="rc_rate"]'),N=e('.pid_tuning input[name="rc_rate_yaw"]'),I=e('.pid_tuning input[name="rc_pitch_expo"]'),C=e('.pid_tuning input[name="rc_expo"]'),w=e('.pid_tuning input[name="rc_yaw_expo"]'),D=e("#pid-tuning .pid_titlebar .rc_rate"),x=e("#pid-tuning .pid_titlebar .rate"),S=e("#pid-tuning .pid_titlebar .rc_expo"),V=e("#pid-tuning .pid_titlebar .centerSensitivity");let v=1 .toFixed(2),j=.7.toFixed(2),B=0 .toFixed(2);switch(r&&(G.val(t.RC_TUNING.pitch_rate.toFixed(2)),k.val(t.RC_TUNING.roll_rate.toFixed(2)),Y.val(t.RC_TUNING.yaw_rate.toFixed(2)),pe.val(t.RC_TUNING.rcPitchRate.toFixed(2)),m.val(t.RC_TUNING.RC_RATE.toFixed(2)),N.val(t.RC_TUNING.rcYawRate.toFixed(2)),I.val(t.RC_TUNING.RC_PITCH_EXPO.toFixed(2)),C.val(t.RC_TUNING.RC_EXPO.toFixed(2)),w.val(t.RC_TUNING.RC_YAW_EXPO.toFixed(2))),i.currentRatesType){case t.RATES_TYPE.RACEFLIGHT:D.text(F.getMessage("pidTuningRcRateRaceflight")),x.text(F.getMessage("pidTuningRateRaceflight")),S.text(F.getMessage("pidTuningRcExpoRaceflight")),o=2e3,c=10,g=10,n=255,R=1,_=100,p=1,r?(G.val((t.RC_TUNING.pitch_rate*100).toFixed(0)),k.val((t.RC_TUNING.roll_rate*100).toFixed(0)),Y.val((t.RC_TUNING.yaw_rate*100).toFixed(0)),pe.val((t.RC_TUNING.rcPitchRate*1e3).toFixed(0)),m.val((t.RC_TUNING.RC_RATE*1e3).toFixed(0)),N.val((t.RC_TUNING.rcYawRate*1e3).toFixed(0)),I.val((t.RC_TUNING.RC_PITCH_EXPO*100).toFixed(0)),C.val((t.RC_TUNING.RC_EXPO*100).toFixed(0)),w.val((t.RC_TUNING.RC_YAW_EXPO*100).toFixed(0))):(v=370 .toFixed(0),j=80 .toFixed(0),B=50 .toFixed(0));break;case t.RATES_TYPE.KISS:D.text(F.getMessage("pidTuningRcRate")),x.text(F.getMessage("pidTuningRcRateRaceflight")),S.text(F.getMessage("pidTuningRcExpoKISS")),n=.99;break;case t.RATES_TYPE.ACTUAL:D.text(F.getMessage("pidTuningRcRateActual")),x.text(F.getMessage("pidTuningRateQuickRates")),S.text(F.getMessage("pidTuningRcExpoRaceflight")),E=10,n=2e3,R=10,o=2e3,c=10,g=10,r?(G.val((t.RC_TUNING.pitch_rate*1e3).toFixed(0)),k.val((t.RC_TUNING.roll_rate*1e3).toFixed(0)),Y.val((t.RC_TUNING.yaw_rate*1e3).toFixed(0)),pe.val((t.RC_TUNING.rcPitchRate*1e3).toFixed(0)),m.val((t.RC_TUNING.RC_RATE*1e3).toFixed(0)),N.val((t.RC_TUNING.rcYawRate*1e3).toFixed(0))):(v=70 .toFixed(0),j=670 .toFixed(0),B=0 .toFixed(2));break;case t.RATES_TYPE.QUICKRATES:D.text(F.getMessage("pidTuningRcRate")),x.text(F.getMessage("pidTuningRateQuickRates")),S.text(F.getMessage("pidTuningRcExpoRaceflight")),E=10,n=2e3,R=10,r?(G.val((t.RC_TUNING.pitch_rate*1e3).toFixed(0)),k.val((t.RC_TUNING.roll_rate*1e3).toFixed(0)),Y.val((t.RC_TUNING.yaw_rate*1e3).toFixed(0))):j=670 .toFixed(0);break;default:D.text(F.getMessage("pidTuningRcRate")),x.text(F.getMessage("pidTuningRate")),S.text(F.getMessage("pidTuningRcExpo")),V.text(F.getMessage("pidTuningAcroCenterSensitiviy"));break}const b=e('#pid-tuning input[class="rc_rate_input"]'),Q=e('#pid-tuning input[class="rate_input"]'),oe=e('#pid-tuning input[class="expo_input"]');r||(Q.val(j),b.val(v),oe.val(B)),b.attr({max:o,min:c,step:g}).change(),Q.attr({max:n,min:E,step:R}).change(),oe.attr({max:_,min:A,step:p}).change(),r&&i.setDirty(!1)};L.changeRatesTypeLogo=function(){const r=this,i=e('.rates_type img[id="ratesLogo"]');switch(r.currentRatesType){case t.RATES_TYPE.RACEFLIGHT:i.attr("src","./images/rate_logos/raceflight.svg");break;case t.RATES_TYPE.KISS:i.attr("src","./images/rate_logos/kiss.svg");break;case t.RATES_TYPE.ACTUAL:i.attr("src","./images/rate_logos/actual.svg");break;case t.RATES_TYPE.QUICKRATES:i.attr("src","./images/rate_logos/quickrates.svg");break;default:i.attr("src","./images/rate_logos/betaflight.svg");break}};L.expertModeChanged=function(r){s.setExpertMode(r)};L.sliderOnScroll=function(r,i){r.parent().on("input wheel",function(o){var _,p;if(r.prop("disabled")||!((_=o.originalEvent)!=null&&_.deltaY&&((p=o.originalEvent)!=null&&p.altKey)))return;o.preventDefault();const c=parseFloat(r.attr("step")),g=o.originalEvent.deltaY>0?-c:c,n=He(r.val())?parseInt(r.val()):parseFloat(r.val()),R=(Math.floor(n*100)+Math.floor(g*100))/100;r.val(R),r.trigger("input"),r.trigger("change")})};Ue.pid_tuning=L;export{L as pid_tuning};
